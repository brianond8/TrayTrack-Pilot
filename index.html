<!-- Version 2.2 - PWA with Offline Support -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TrayTrack">
    <link rel="manifest" href="/manifest.json">
    <!-- <link rel="apple-touch-icon" href="/icon-192.png"> -->
    <title>TrayTrack - Medical Device Inventory</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            padding: 0;
            padding-bottom: 80px;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
                padding-bottom: 80px;
            }
        }
        
        /* Desktop: add padding to container elements */

        /* Hide legacy success/error banner (TrayTrack) */
#successMsg,
#errorMsg {
    display: none !important;
}


@media (min-width: 768px) {
    .header,
    #traysTab > div:first-child,
    #doctorsTab > div:first-child,
    #notesTab > div:first-child,
    #calendarTab > div:first-child,
    #adminTab .admin-section,
    #trayList,
    #doctorList,
    #noteList,
    #calendar {
        margin-left: 0;
        margin-right: 0;
    }
}

/* Mobile: no side margins, full-width dashboard */
@media (max-width: 767px) {
    #dashboardContent > div {
        margin-left: 12px !important;
        margin-right: 12px !important;
    }
    
    #traysTab > div:first-child,
    #doctorsTab > div:first-child,
    #notesTab > div:first-child,
    #calendarTab > div:first-child,
    #trayList,
    #doctorList,
    #noteList,
    #calendar {
        margin-left: 12px;
        margin-right: 12px;
    }
}

#dashboardTab {
    margin: 0;
    padding: 0;
}

#dashboardContent {
    margin: 0;
    padding: 0;
}
        

        
        .header {
    background: white;
    padding: 16px 20px;
    border-radius: 0;
    margin-bottom: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: none;
    border-bottom: 1px solid #e5e7eb;
}

@media (min-width: 768px) {
    .header {
        padding: 28px 32px;
        border-radius: 16px;
        margin-bottom: 24px;
        border: 1px solid #e5e7eb;
    }
}
        
        h1 {
            font-size: 22px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 28px;
                margin-bottom: 8px;
            }
        }
        
        .user-info {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }
        
        .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 4px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    touch-action: pan-x;
}

        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        @media (max-width: 767px) {
    body {
        padding: 0;
        background: #f5f5f7;
    }
    
    .header {
        margin: 0 0 12px 0;
        padding: 20px 16px;
        background: white;
        border-radius: 0;
        box-shadow: none;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .tabs {
    margin: 0 12px 6px 12px;
    padding: 6px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
    
    .tab {
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 8px;
        min-width: fit-content;
    }
    
    .tab.active {
        background: #6366f1;
        color: white;
    }
}

@media (min-width: 768px) {
    .tabs {
        gap: 8px;
        margin-bottom: 24px;
        padding: 12px 0;
    }
}
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
            color: #6b7280;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .tab {
                padding: 10px 24px;
                font-size: 15px;
            }
        }
        
        .tab:hover {
            background: #f3f4f6;
            color: #4f46e5;
        }
        
        .tab.active {
            background: #6366f1;
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #6366f1;
            border-radius: 50%;
        }
        
        @media (min-width: 768px) {
            .tab.active::after {
                bottom: -12px;
            }
        }
        
        .tray-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .tray-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            min-height: 80px;
        }
        
        @media (min-width: 768px) {
            .tray-card {
                padding: 20px;
            }
        }
        
        .tray-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .tray-card:active {
            transform: translateY(0);
        }
        
        .tray-card.green { border-color: #34c759; }
        .tray-card.blue { border-color: #007aff; }
        .tray-card.yellow { border-color: #ffcc00; }
        .tray-card.orange { border-color: #ff9500; }
        .tray-card.red { border-color: #ff3b30; }
        
        .tray-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1f2937;
            letter-spacing: -0.3px;
        }
        
        .tray-status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        .status-ready { background: #d1f4e0; color: #00713d; }
        .status-in_location { background: #d1e7ff; color: #0051a5; }
        .status-needs_restock { background: #ffe5d1; color: #9a4500; }
        
        .tray-location {
            font-size: 14px;
            color: #86868b;
            margin-top: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            animation: slideUp 0.2s ease;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (min-width: 768px) {
            .modal-content {
                padding: 32px;
            }
        }
        
        .modal-content::-webkit-scrollbar {
            display: none;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(16px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #111827;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1d1d1f;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            min-height: 44px;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .item-list {
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .item-checkbox {
            padding: 12px;
            border-bottom: 1px solid #f5f5f7;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .item-checkbox:last-child {
            border-bottom: none;
        }
        
        .item-checkbox input {
            width: 20px;
            height: 20px;
        }
        
        .item-checkbox label {
            flex: 1;
            font-size: 14px;
        }
        
        .critical-badge {
            background: linear-gradient(135deg, #ff3b30 0%, #d32f2f 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
            display: inline-block;
            margin-left: 6px;
        }
        
        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4f46e5;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }
        
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.2);
            border-left: 4px solid #c62828;
            animation: slideIn 0.3s ease;
        }
        
        .success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
            border-left: 4px solid #2e7d32;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }
        
        @media (min-width: 768px) {
            .priority-selector {
                gap: 8px;
                margin-top: 8px;
            }
        }
        
        .priority-btn {
            padding: 16px;
            border: 2px solid rgba(209, 213, 219, 0.5);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .priority-btn:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .priority-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .admin-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        /* Calendar Styles */
        #calendar {
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        @media (min-width: 768px) {
            #calendar {
                padding: 20px;
            }
        }

        .fc-event {
            cursor: pointer;
        }
        
        /* Mobile Calendar Optimizations */
        .fc .fc-toolbar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px !important;
        }
        
        .fc .fc-toolbar-title {
            font-size: 18px !important;
            order: -1;
            margin-bottom: 8px;
        }
        
        .fc .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
        }
        
        .fc .fc-button {
            padding: 8px 12px !important;
            font-size: 13px !important;
            min-height: 44px;
        }
        
        .fc .fc-button-group {
            display: flex;
            gap: 4px;
        }
        
        @media (min-width: 768px) {
            .fc .fc-toolbar {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .fc .fc-toolbar-title {
                font-size: 24px !important;
                order: 0;
                margin-bottom: 0;
            }
            
            .fc .fc-button {
                padding: 10px 16px !important;
                font-size: 14px !important;
            }
        }

        .case-detail-modal {
            font-size: 14px;
            line-height: 1.6;
        }

        .case-detail-modal .detail-row {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f5f5f7;
        }

        .case-detail-modal .detail-row:last-child {
            border-bottom: none;
        }

        .case-detail-modal .detail-label {
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .case-detail-modal .detail-value {
            color: #86868b;
        }

        .doctor-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 12px;
            border-left: 4px solid #6366f1;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .doctor-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .doctor-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .doctor-specialty {
            font-size: 14px;
            color: #6366f1;
            margin-bottom: 8px;
        }

        .doctor-contact {
            font-size: 13px;
            color: #6b7280;
        }

        .note-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

        .note-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .note-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .note-preview {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-pins {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .pin-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #ede9fe;
            color: #6366f1;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .pinned-note {
            background: #fffbeb;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 3px solid #f59e0b;
        }

        .pinned-note-title {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
        }

        .pinned-note-content {
            font-size: 13px;
            color: #78350f;
            white-space: pre-wrap;
        }

        .pin-to-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .pin-to-label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .pin-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin-bottom: 6px;
        }

        .pin-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .pin-checkbox label {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .form-textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .loading-spinner {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        /* Sync Badge Pulse */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #syncBadge {
            animation: pulse 2s ease-in-out infinite;
        }

        /* Install prompt animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
</style>

</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div style="background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üß≥</div>
                <h1 style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">TrayTrack AI</h1>
                <p style="font-size: 14px; color: #6b7280;">Medical Device Inventory Management</p>
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Username</label>
                <input type="text" id="loginUsername" placeholder="Enter your username" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;" />
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Display Name</label>
                <input type="text" id="loginDisplayName" placeholder="Your full name" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px;" />
            </div>
            
            <button onclick="handleLogin()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                Continue
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: #9ca3af; text-align: center;">No password needed for pilot testing</p>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" style="display: none;">
        <div id="successMsg" class="success-msg">Success!</div>
        <div id="errorMsg" class="error-msg">Error occurred</div>
        
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1>TrayTrack AI</h1>
                    <div class="user-info">
                        <span id="userName">Loading...</span>
                        <button onclick="handleLogout()" style="margin-left: 12px; padding: 4px 12px; background: transparent; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">Logout</button>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">v2.2-pilot</div>
                    <button onclick="showFeedbackForm()" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">üí¨ Feedback</button>
                </div>
            </div>
        </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="tab" onclick="showTab('trays')">Trays & Products</button>
        <button class="tab" onclick="showTab('doctors')">Doctors</button>
        <button class="tab" onclick="showTab('notes')">Notes</button>
        <button class="tab" onclick="showTab('calendar')">Calendar</button>
        <button class="tab" onclick="showTab('metrics')">Metrics</button>
        <button class="tab" onclick="showTab('admin')">Add Products</button>
    </div>


    <div id="errorMsg" style="display:none;" class="error"></div>
    <div id="successMsg" style="display:none;" class="success"></div>

    <!-- DASHBOARD TAB -->
    <div id="dashboardTab">
        <div id="dashboardContent" class="loading">Loading dashboard...</div>
    </div>

    <!-- TRAYS & PRODUCTS TAB -->
<div id="traysTab" style="display:none;">
    <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label">Search Products</label>
            <div style="position: relative;">
                <input type="text" id="traySearchInput" class="form-input" placeholder="Search by product name..." oninput="searchTrays()" style="padding-right: 40px;">
                <button id="clearSearchBtn" onclick="clearSearch()" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #86868b; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
            </div>
        </div>
        <label class="form-label">Sort By:</label>
        <select id="traySortSelect" class="form-select" onchange="sortTrays()">
            <option value="readiness">Readiness (Ready first)</option>
            <option value="priority">Restock Priority (Urgent first)</option>
            <option value="location">Location</option>
            <option value="case_date">Upcoming Case Date</option>
        </select>
    </div>
    <div id="trayList" class="tray-list">
        <div class="loading">Loading products...</div>
    </div>
</div>

    <!-- DOCTORS TAB -->
    <div id="doctorsTab" style="display:none;">
        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="form-group" style="margin-bottom: 12px;">
                <label class="form-label">Search Doctors</label>
                <div style="position: relative;">
                    <input type="text" id="doctorSearchInput" class="form-input" placeholder="Search by name, specialty, hospital..." oninput="searchDoctors()" style="padding-right: 40px;">
                    <button id="clearDoctorSearchBtn" onclick="clearDoctorSearch()" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #86868b; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="showCreateDoctorForm()" style="width: auto; padding: 12px 24px;">+ Add Doctor</button>
        </div>
        <div id="doctorList" class="tray-list">
            <div class="loading">Loading doctors...</div>
        </div>
    </div>


    <!-- NOTES TAB -->
    <div id="notesTab" style="display:none;">
        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="form-group" style="margin-bottom: 12px;">
                <label class="form-label">Search Notes</label>
                <div style="position: relative;">
                    <input type="text" id="noteSearchInput" class="form-input" placeholder="Search by title or content..." oninput="searchNotes()" style="padding-right: 40px;">
                    <button id="clearNoteSearchBtn" onclick="clearNoteSearch()" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #86868b; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
                <label class="form-label">Filter By:</label>
                <select id="noteFilterSelect" class="form-select" onchange="filterNotes()">
                    <option value="recent">Recently Edited</option>
                    <option value="trays">Pinned to Trays</option>
                    <option value="standalone">Pinned to Standalone Items</option>
                    <option value="cases">Pinned to Cases</option>
                    <option value="doctors">Pinned to Doctors</option>
                    <option value="unpinned">Not Pinned</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="showCreateNoteForm()" style="width: auto; padding: 12px 24px;">+ Create Note</button>
        </div>
        <div id="noteList" class="tray-list">
            <div class="loading">Loading notes...</div>
        </div>
    </div>

    <!-- BILLING NOTES TAB (Legacy - kept for quick notes from dashboard) -->
    <div id="billingNotesTab" style="display:none;">
        <div id="billingNotesList" class="tray-list">
            <div class="loading">Loading billing notes...</div>
        </div>
    </div>


    <!-- BILLING NOTES MODAL -->
    <div id="billingNotesModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">Quick Note</div>
            <textarea id="billingNotesTextarea" style="width: 100%; min-height: 400px; padding: 16px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: monospace; resize: vertical; margin-bottom: 16px;" placeholder="Start typing your note..."></textarea>
            <button class="btn btn-primary" onclick="saveBillingNote()">Save Note</button>
            <button class="btn btn-secondary" onclick="closeBillingNotesModal()">Cancel</button>
        </div>
    </div>

    <!-- CALENDAR TAB (FIXED - No longer nested!) -->
    <div id="calendarTab" style="display:none;">
        <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" onclick="showBookCaseForm()" style="width: auto; padding: 12px 24px;">+ Book a Case</button>
        </div>

        <div id="calendar"></div>
    </div>

<!-- METRICS TAB -->
    <div id="metricsTab" style="display:none;">
        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h2 style="margin-bottom: 16px; font-size: 22px; font-weight: 700; color: #1f2937;">üìä Item Utilization Metrics</h2>
            <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Track usage of all items across trays and standalone products</p>
            
            <div class="form-group">
                <label class="form-label">Time Period</label>
                <select id="metricsTimePeriod" class="form-select" onchange="loadMetrics()">
                    <option value="all">All Time</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Filter By</label>
                <select id="metricsFilter" class="form-select" onchange="filterMetrics()">
                    <option value="all">All Items</option>
                    <option value="tray">Tray Items Only</option>
                    <option value="standalone">Standalone Items Only</option>
                    <option value="critical">Critical Items Only</option>
                </select>
            </div>
        </div>
        
        <div id="metricsSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
            <!-- Summary cards will be inserted here -->
        </div>
        
        <div id="metricsContent" style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="loading">Loading metrics...</div>
        </div>
    </div>    
    
    <!-- ADD PRODUCTS TAB -->
<div id="adminTab" style="display:none;">
    <div class="admin-section">
        <h2 style="margin-bottom: 16px;">Data Management</h2>
        <p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">Export your data for backup or analysis</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
            <button class="btn btn-primary" onclick="exportAllData()" style="background: #10b981;">üì• Export All Data</button>
            <button class="btn btn-primary" onclick="exportMetrics()" style="background: #f59e0b;">üìä Export Metrics</button>
            <button class="btn btn-secondary" onclick="showDataStats()">üìà View Stats</button>
        </div>
        <details style="margin-top: 16px;">
            <summary style="cursor: pointer; font-size: 13px; color: #ef4444; font-weight: 600;">‚ö†Ô∏è Danger Zone</summary>
            <div style="margin-top: 12px; padding: 12px; background: #fef2f2; border-radius: 8px; border-left: 3px solid #ef4444;">
                <p style="font-size: 13px; color: #991b1b; margin-bottom: 12px;">Clear all local data (for testing only)</p>
                <button class="btn" onclick="clearAllData()" style="background: #ef4444; color: white; width: auto; padding: 8px 16px;">Clear All Local Data</button>
            </div>
        </details>
    </div>
    
    <div class="admin-section">
        <h2 style="margin-bottom: 16px;">Create Tray</h2>
        <div class="form-group">
            <label class="form-label">Tray Name</label>
            <input type="text" id="newTrayName" class="form-input" placeholder="e.g., Spine-001">
        </div>
        <button class="btn btn-primary" onclick="createTray()">Create Tray</button>
    </div>
    
    <div class="admin-section">
        <h2 style="margin-bottom: 16px;">Add Items</h2>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <button class="btn btn-primary" onclick="showAddItemToTrayForm()">Add Item to Tray</button>
            <button class="btn btn-primary" onclick="showAddStandaloneItemForm()">Add Standalone Item</button>
        </div>
        
        <div id="addItemForm" style="display: none; margin-top: 20px;">
            <!-- Form content will be inserted here -->
        </div>
    </div>
</div>

    <!-- MODAL FOR TRAY DETAILS -->
    <div id="trayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTrayName">Tray Details</div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- MODAL FOR CASE DETAILS -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Case Details</div>
            <div id="caseModalContent" class="case-detail-modal"></div>
        </div>
    </div>

    <script>
        // API Configuration
        const getApiUrl = () => {
    // Development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8000';
    }
    
    // Production - use your actual Render backend URL
    const API_DOMAIN = 'https://traytrack-pilot.onrender.com';
    return API_DOMAIN;
};
        
        const API_URL = getApiUrl();
        
        let USER_ID = null;
        let CURRENT_USER = null;
        let currentTray = null;
        let allTrays = [];
        let allCases = [];
        let allDoctors = [];
        let allNotes = [];
        let calendar = null;
        let pendingSyncCount = 0;


        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('dashboardTab').style.display = 'none';
            document.getElementById('traysTab').style.display = 'none';
            document.getElementById('doctorsTab').style.display = 'none';
            document.getElementById('notesTab').style.display = 'none';
            document.getElementById('calendarTab').style.display = 'none';
            document.getElementById('billingNotesTab').style.display = 'none';
            document.getElementById('metricsTab').style.display = 'none';
            document.getElementById('adminTab').style.display = 'none';
            if (tab !== 'dashboard') {
                document.getElementById('dashboardContent').innerHTML = '';
            }
            if (tab === 'dashboard') {
                document.getElementById('dashboardTab').style.display = 'block';
                loadDashboard();
            } else if (tab === 'trays') {
                document.getElementById('traysTab').style.display = 'block';
                loadTrays();
            } else if (tab === 'doctors') {
                document.getElementById('doctorsTab').style.display = 'block';
                loadDoctors();
            } else if (tab === 'notes') {
                document.getElementById('notesTab').style.display = 'block';
                loadNotes();
            } else if (tab === 'calendar') {
                document.getElementById('calendarTab').style.display = 'block';
                loadTraysForCases();
                initializeCalendar();
            } else if (tab === 'billingNotes') {
                document.getElementById('billingNotesTab').style.display = 'block';
                loadBillingNotesList();
            } else if (tab === 'metrics') {
                document.getElementById('metricsTab').style.display = 'block';
                loadMetrics();
            } else if (tab === 'admin') {
                document.getElementById('adminTab').style.display = 'block';
                loadTraysForAdmin();
            }
        }


        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/trays?sort=priority`);
                const trays = await response.json();
                
                const casesResponse = await fetch(`${API_URL}/cases`);
                const cases = await casesResponse.json();
                
                renderDashboard(trays, cases);
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = '<div class="error" style="margin: 0 12px;">Failed to load dashboard</div>';
                console.error(error);
            }
        }

        function renderDashboard(trays, cases) {
            // Store globally so other functions can access
            allTrays = trays;
            allCases = cases;
            
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const twoDaysFromNow = new Date(todayStart);
            twoDaysFromNow.setDate(twoDaysFromNow.getDate() + 2);
            twoDaysFromNow.setHours(23, 59, 59, 999);
            
            // Get cases within next 2 calendar days
            const upcomingCases = cases.filter(c => {
                const caseDate = new Date(c.case_date);
                return caseDate >= now && caseDate <= twoDaysFromNow;
            }).sort((a, b) => new Date(a.case_date) - new Date(b.case_date));
            
            // Get trays with critical items
            const traysWithCriticalItems = trays.filter(tray => 
                tray.items.some(item => item.is_critical && (item.qty_on_hand || 0) === 0)
            );
            
            // Calculate stats - count all fully stocked trays regardless of status or location
            const readyTrays = trays.filter(t => {
                // A tray is fully stocked if all items with qty_expected are at 100%
                if (t.items.length === 0) return false;
                return t.items.every(item => {
                    if (!item.qty_expected) return true; // Items without expected qty don't count against stock
                    return (item.qty_on_hand || 0) >= item.qty_expected;
                });
            }).length;
            // Count all trays that need restock - either status is needs_restock OR any items below 100%
            const needRestockTrays = trays.filter(t => {
                if (t.status === 'needs_restock') return true;
                return t.items.some(item => {
                    if (!item.qty_expected) return false;
                    const current = item.qty_on_hand || 0;
                    return current < item.qty_expected;
                });
            }).length;
            const p1Trays = trays.filter(t => t.color === 'red').length;      // P1 = Red = Highest priority
            const p2Trays = trays.filter(t => t.color === 'orange').length;   // P2 = Orange = Medium priority
            const p3Trays = trays.filter(t => t.color === 'yellow').length;   // P3 = Yellow = Lowest priority
            
            // Get all upcoming cases (for the upcoming cases section - next 7 days from now)
            const sevenDaysFromNow = new Date(now);
            sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
            const allUpcomingCases = cases.filter(c => {
                const caseDate = new Date(c.case_date);
                return caseDate >= now && caseDate <= sevenDaysFromNow;
            }).sort((a, b) => new Date(a.case_date) - new Date(b.case_date));
            
            // Build 2 Day Timeline Section (Cases within 2 days)
            let twoDayTimelineHtml = '';
            if (upcomingCases.length > 0) {
                twoDayTimelineHtml = '<div style="background: #e3f2fd; padding: 16px; border-radius: 12px; margin: 0 0 12px 0; border-left: 4px solid #2196f3;">';
                twoDayTimelineHtml += '<div style="font-size: 18px; font-weight: 600; color: #1565c0; margin-bottom: 12px;">üìÖ 2 Day Timeline</div>';   
                
                upcomingCases.forEach(c => {
                    const caseDate = new Date(c.case_date);
                    const daysUntil = Math.ceil((caseDate - now) / (1000 * 60 * 60 * 24));
                    const timeStr = caseDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const dateStr = caseDate.toLocaleDateString();
                    
                    let trayStatus = '';
                    
                    if (c.tray_id) {
                        const tray = trays.find(t => t.id === c.tray_id);
                        if (tray) {
                            // Check if tray is at the case location
                            const isAtLocation = tray.last_location_type === 'Hospital' && 
                                                tray.last_location_name && 
                                                c.location.toLowerCase().includes(tray.last_location_name.toLowerCase());
                            
                            if (isAtLocation) {
                                trayStatus = `<span style="color: #2e7d32; font-weight: 600;">üü¢ ${tray.name} at location</span>`;
                            } else {
                                trayStatus = `<span style="color: #c62828; font-weight: 600;">üî¥ ${tray.name} not dropped off</span>`;
                            }
                        }
                    } else if (c.tray_other) {
                        trayStatus = `<span style="color: #86868b;">Tray: ${c.tray_other}</span>`;
                    } else {
                        trayStatus = `<span style="color: #86868b;">No tray assigned</span>`;
                    }
                    
                    let urgencyText;
                    if (daysUntil === 0) {
                        urgencyText = 'TODAY';
                    } else if (daysUntil === 1) {
                        urgencyText = 'TOMORROW';
                    } else {
                        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        urgencyText = dayNames[caseDate.getDay()];
                    }
                    
                    twoDayTimelineHtml += `
                        <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${c.procedure} - ${urgencyText}</div>
                            <div style="font-size: 14px; color: #86868b;">${dateStr} at ${timeStr} ‚Ä¢ ${c.location}</div>
                            <div style="font-size: 14px; margin-top: 4px;">${trayStatus}</div>
                        </div>
                    `;
                });
                
                twoDayTimelineHtml += '</div>';
            }
            
            // Build Priority Restocks Section (Trays with ANY empty items)
            const traysWithEmptyItems = trays.filter(tray => 
                tray.items.some(item => {
                    if (!item.qty_expected) return false;
                    return (item.qty_on_hand || 0) === 0;
                })
            );
            
            let priorityRestocksHtml = '';
            if (traysWithEmptyItems.length > 0) {
            priorityRestocksHtml = '<div style="background: #ffebee; padding: 16px; border-radius: 12px; margin: 0 0 12px 0; border-left: 4px solid #ff3b30;">';
                
                traysWithEmptyItems.forEach(tray => {
                    const emptyItems = tray.items.filter(item => {
                        if (!item.qty_expected) return false;
                        return (item.qty_on_hand || 0) === 0;
                    });
                    
                    const criticalEmptyItems = emptyItems.filter(item => item.is_critical);
                    const nonCriticalEmptyItems = emptyItems.filter(item => !item.is_critical);
                    
                    let itemsText = '';
                    if (criticalEmptyItems.length > 0) {
                        itemsText = `<span style="color: #c62828; font-weight: 600;">${criticalEmptyItems.length} CRITICAL item${criticalEmptyItems.length > 1 ? 's' : ''} empty</span>`;
                        if (nonCriticalEmptyItems.length > 0) {
                            itemsText += `, ${nonCriticalEmptyItems.length} other item${nonCriticalEmptyItems.length > 1 ? 's' : ''} empty`;
                        }
                    } else {
                        itemsText = `${emptyItems.length} item${emptyItems.length > 1 ? 's' : ''} empty`;
                    }
                    
                    priorityRestocksHtml += `
                        <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="openTray(${tray.id})">
                            <div style="font-weight: 600; margin-bottom: 4px;">${tray.name}</div>
                            <div style="font-size: 14px; color: #c62828;">${itemsText}</div>
                        </div>
                    `;
                });
                
                priorityRestocksHtml += '</div>';
        }
        
// Build Stats Summary Section - adjust padding based on notifications
        const hasNotifications = twoDayTimelineHtml || priorityRestocksHtml;
        const statsTopPadding = hasNotifications ? '0' : '12px';
        let statsHtml = `<div style="padding: ${statsTopPadding} 12px 0 12px;">`;
        
        // Standalone Cases This Week button
        statsHtml += `
            <div onclick="showCasesThisWeek()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; margin-bottom: 12px; -webkit-tap-highlight-color: transparent;" onmouseover="this.style.transform='scale(1.02)'; this.style.transition='transform 0.2s'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 36px; font-weight: 700; color: #007aff;">${allUpcomingCases.length}</div>
                <div style="font-size: 15px; color: #86868b; margin-top: 6px; font-weight: 500;">Cases This Week</div>
            </div>
        `;
        
        // Two-column grid for Stocked and Need Restock
        statsHtml += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">';
        
        statsHtml += `
            <div onclick="showStockedTrays()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; -webkit-tap-highlight-color: transparent;" onmouseover="this.style.transform='scale(1.02)'; this.style.transition='transform 0.2s'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 36px; font-weight: 700; color: #34c759;">${readyTrays}</div>
                <div style="font-size: 15px; color: #86868b; margin-top: 6px; font-weight: 500;">Stocked Trays</div>
            </div>
            
            <div onclick="showNeedRestockTrays()" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; -webkit-tap-highlight-color: transparent;" onmouseover="this.style.transform='scale(1.02)'; this.style.transition='transform 0.2s'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 36px; font-weight: 700; color: #ff9500;">${needRestockTrays}</div>
                <div style="font-size: 15px; color: #86868b; margin-top: 6px; font-weight: 500;">Need Restock</div>
            </div>
        `;
        
        statsHtml += '</div>';
        statsHtml += '</div>'; // Close padding wrapper
        
        // Build search bar
        const searchBar = `
            <div style="margin: 0 12px 12px 12px;">
                <div style="position: relative;">
                    <input type="text" id="globalSearchInput" class="form-input" placeholder="üîç Search trays, cases, doctors, notes..." oninput="performGlobalSearch()" style="padding-right: 40px;">
                    <button id="clearGlobalSearchBtn" onclick="clearGlobalSearch()" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: #86868b; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; line-height: 1;">√ó</button>
                </div>
                <div id="globalSearchResults" style="display: none; margin-top: 12px;"></div>
            </div>
        `;
        
        // Assemble final dashboard HTML
        // If there are notifications, show them first, then button, then stats
        // If no notifications, show button first, then stats
        const quickAddButton = `<div style="margin: 0 12px 12px 12px;"><button class="btn btn-primary" onclick="showQuickAddOptions()" style="width: 100%; padding: 16px 24px; font-size: 16px;">‚ö° Quick Add</button></div>`;
        
        const dashboardContent = searchBar + (hasNotifications 
            ? twoDayTimelineHtml + priorityRestocksHtml + quickAddButton + statsHtml
            : quickAddButton + statsHtml);
        
        document.getElementById('dashboardContent').innerHTML = dashboardContent;
    }

    function showStockedTrays() {
            // Show all trays that are fully stocked, regardless of status or location
            const stockedTrays = allTrays.filter(t => {
                // A tray is fully stocked if all items with qty_expected are at 100%
                if (t.items.length === 0) return false;
                return t.items.every(item => {
                    if (!item.qty_expected) return true; // Items without expected qty don't count against stock
                    return (item.qty_on_hand || 0) >= item.qty_expected;
                });
            });
            
            if (stockedTrays.length === 0) {
                document.getElementById('modalTrayName').textContent = 'Stocked Trays';
                document.getElementById('modalContent').innerHTML = '<div style="text-align: center; padding: 20px; color: #86868b;">No fully stocked trays</div><button class="btn btn-secondary" onclick="closeModal()">Close</button>';
                document.getElementById('trayModal').classList.add('show');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            stockedTrays.forEach(tray => {
                // Find next case for this tray
                const now = new Date();
                const upcomingCases = allCases.filter(c => c.tray_id === tray.id && new Date(c.case_date) > now);
                let caseInfo = '<span style="color: #86868b;">No upcoming cases</span>';
                
                if (upcomingCases.length > 0) {
                    const nextCase = upcomingCases.sort((a, b) => new Date(a.case_date) - new Date(b.case_date))[0];
                    const caseDate = new Date(nextCase.case_date);
                    const dateStr = caseDate.toLocaleDateString();
                    const timeStr = caseDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    caseInfo = `<span style="color: #007aff;">${nextCase.procedure} - ${dateStr} ${timeStr}</span>`;
                }
                
                const locationInfo = tray.last_location_type 
                    ? `${tray.last_location_type}${tray.last_location_name ? ' - ' + tray.last_location_name : ''}`
                    : 'No location set';
                
                html += `
                    <div onclick="openTray(${tray.id}); closeModal();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${tray.name}</div>
                        <div style="font-size: 14px; color: #86868b;">üìç ${locationInfo}</div>
                        <div style="font-size: 14px; margin-top: 4px;">${caseInfo}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';
            
            document.getElementById('modalTrayName').textContent = `Stocked Trays (${stockedTrays.length})`;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('trayModal').classList.add('show');
        }

        function showNeedRestockTrays() {
            // Show ALL trays that need restock - filter by items needing attention, not just status
            const needRestockTrays = allTrays.filter(t => {
                // Include if status is needs_restock
                if (t.status === 'needs_restock') return true;
                
                // Also include if any items are below 100% stock
                return t.items.some(item => {
                    if (!item.qty_expected) return false;
                    const current = item.qty_on_hand || 0;
                    return current < item.qty_expected;
                });
            });
            
            if (needRestockTrays.length === 0) {
                document.getElementById('modalTrayName').textContent = 'Need Restock';
                document.getElementById('modalContent').innerHTML = '<div style="text-align: center; padding: 20px; color: #86868b;">No trays need restocking</div><button class="btn btn-secondary" onclick="closeModal()">Close</button>';
                document.getElementById('trayModal').classList.add('show');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            needRestockTrays.forEach(tray => {
                const colorEmoji = tray.color === 'red' ? 'üî¥' : tray.color === 'orange' ? 'üü†' : tray.color === 'yellow' ? 'üü°' : 'üîµ';
                const priorityText = tray.priority_numeric ? `P${tray.priority_numeric}` : tray.priority_partial ? 'Partial' : '';
                
                // Categorize items by status
                let criticalEmptyCount = 0;
                let emptyCount = 0;
                let lowCount = 0;
                let needsAttentionCount = 0;
                
                tray.items.forEach(item => {
                    if (!item.qty_expected) return;
                    const current = item.qty_on_hand || 0;
                    const expected = item.qty_expected;
                    const percent = (current / expected) * 100;
                    
                    // Critical empty items (any critical item at 0)
                    if (current === 0 && item.is_critical) {
                        criticalEmptyCount++;
                    }
                    // Empty items (non-critical at 0)
                    else if (current === 0) {
                        emptyCount++;
                    }
                    // Low stock (below 50%)
                    else if (percent < 50) {
                        lowCount++;
                    }
                    // Needs attention (50-99%)
                    else if (percent < 100) {
                        needsAttentionCount++;
                    }
                });
                
                // Build status message in priority order
                let statusParts = [];
                if (criticalEmptyCount > 0) statusParts.push(`${criticalEmptyCount} critical item${criticalEmptyCount > 1 ? 's' : ''} empty`);
                if (emptyCount > 0) statusParts.push(`${emptyCount} item${emptyCount > 1 ? 's' : ''} empty`);
                if (lowCount > 0) statusParts.push(`${lowCount} item${lowCount > 1 ? 's' : ''} low`);
                if (needsAttentionCount > 0) statusParts.push(`${needsAttentionCount} item${needsAttentionCount > 1 ? 's' : ''} need${needsAttentionCount === 1 ? 's' : ''} attention`);
                
                const statusText = statusParts.length > 0 ? statusParts.join(', ') : 'Review needed';
                
                // Find next case for this tray
                const now = new Date();
                const upcomingCases = allCases.filter(c => c.tray_id === tray.id && new Date(c.case_date) > now);
                let caseInfo = '';
                
                if (upcomingCases.length > 0) {
                    const nextCase = upcomingCases.sort((a, b) => new Date(a.case_date) - new Date(b.case_date))[0];
                    const caseDate = new Date(nextCase.case_date);
                    const dateStr = caseDate.toLocaleDateString();
                    const timeStr = caseDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    caseInfo = `<div style="font-size: 14px; margin-top: 4px; color: #007aff;">${nextCase.procedure} - ${dateStr} ${timeStr}</div>`;
                }
                
                const locationInfo = tray.last_location_type 
                    ? `${tray.last_location_type}${tray.last_location_name ? ' - ' + tray.last_location_name : ''}`
                    : 'No location set';
                
                html += `
                    <div onclick="openTray(${tray.id}); closeModal();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${colorEmoji} ${tray.name} ${priorityText ? '- ' + priorityText : ''}</div>
                        <div style="font-size: 14px; color: #c62828;">${statusText}</div>
                        <div style="font-size: 14px; color: #86868b; margin-top: 4px;">üìç ${locationInfo}</div>
                        ${caseInfo}
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';
            
            document.getElementById('modalTrayName').textContent = `Need Restock (${needRestockTrays.length})`;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('trayModal').classList.add('show');
        }

        function showCasesThisWeek() {
            const now = new Date();
            
            // Calculate this calendar week (Monday-Sunday)
            const thisWeekStart = new Date(now);
            const dayOfWeek = thisWeekStart.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            thisWeekStart.setDate(thisWeekStart.getDate() + daysToMonday);
            thisWeekStart.setHours(0, 0, 0, 0);
            
            const thisWeekEnd = new Date(thisWeekStart);
            thisWeekEnd.setDate(thisWeekStart.getDate() + 6); // Sunday
            thisWeekEnd.setHours(23, 59, 59, 999);
            
            const thisWeekCases = allCases.filter(c => {
                const caseDate = new Date(c.case_date);
                return caseDate >= thisWeekStart && caseDate <= thisWeekEnd;
            }).sort((a, b) => new Date(a.case_date) - new Date(b.case_date));
            
            if (thisWeekCases.length === 0) {
                document.getElementById('modalTrayName').textContent = 'Cases This Week';
                document.getElementById('modalContent').innerHTML = '<div style="text-align: center; padding: 20px; color: #86868b;">No cases scheduled this week</div><button class="btn btn-secondary" onclick="closeModal()">Close</button>';
                document.getElementById('trayModal').classList.add('show');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            thisWeekCases.forEach(c => {
                const caseDate = new Date(c.case_date);
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[caseDate.getDay()];
                const dateStr = caseDate.toLocaleDateString();
                const timeStr = caseDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const trayInfo = c.tray_name || c.tray_other || 'No tray assigned';
                
                // Check if case is in the past
                const isPast = caseDate < now;
                const opacity = isPast ? 'opacity: 0.5;' : '';
                
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid #f5f5f7; ${opacity}">
                        <div style="font-weight: 600; margin-bottom: 4px;">${c.procedure}</div>
                        <div style="font-size: 14px; color: #007aff; margin-bottom: 2px;">${dayName}, ${dateStr} at ${timeStr}</div>
                        <div style="font-size: 14px; color: #86868b;">üìç ${c.location}</div>
                        <div style="font-size: 14px; color: #86868b;">üß≥ ${trayInfo}</div>
                        ${c.doctor ? `<div style="font-size: 14px; color: #86868b;">üë®‚Äç‚öïÔ∏è ${c.doctor}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';
            
            const weekDisplay = `${thisWeekStart.toLocaleDateString()} - ${thisWeekEnd.toLocaleDateString()}`;
            document.getElementById('modalTrayName').textContent = `Cases This Week (${thisWeekCases.length})`;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('trayModal').classList.add('show');
        }

        async function loadTrays() {
    try {
        const traysResponse = await fetch(`${API_URL}/trays?sort=priority`);
        allTrays = await traysResponse.json();
        
        const standalonesResponse = await fetch(`${API_URL}/standalone-items`);
        allStandaloneItems = await standalonesResponse.json();
        
        const casesResponse = await fetch(`${API_URL}/cases`);
        allCases = await casesResponse.json();
        
        sortTrays();
    } catch (error) {
        showError('Failed to load products');
        console.error(error);
    }
}

        let allStandaloneItems = [];

async function sortTrays() {
    const sortBy = document.getElementById('traySortSelect').value;
    const searchTerm = document.getElementById('traySearchInput').value.toLowerCase().trim();
    const listEl = document.getElementById('trayList');
    
    // Filter trays by search term
    let filteredTrays = allTrays;
    let filteredStandalones = allStandaloneItems;
    
    if (searchTerm) {
        filteredTrays = allTrays.filter(tray => 
            tray.name.toLowerCase().includes(searchTerm)
        );
        filteredStandalones = allStandaloneItems.filter(item =>
            item.name.toLowerCase().includes(searchTerm) || 
            (item.sku && item.sku.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filteredTrays.length === 0 && filteredStandalones.length === 0) {
        if (searchTerm) {
            listEl.innerHTML = '<div class="empty-state">No products found matching "' + searchTerm + '"</div>';
        } else {
            listEl.innerHTML = '<div class="empty-state">No products yet.</div>';
        }
        return;
    }
    
    let sortedTrays = [...filteredTrays];
    let sortedStandalones = [...filteredStandalones];
    
    // Define location order
    const locationOrder = ['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other'];
    
    // Priority ranks
    const readinessRank = {
        'green': 0, 'red': 1, 'orange': 2, 'yellow': 3, 'blue': 4
    };
    
    const priorityRank = {
        'red': 0, 'orange': 1, 'yellow': 2, 'blue': 3, 'green': 4
    };
    
    // Sort function
    const applySorting = (items, hasItems = true) => {
        switch(sortBy) {
            case 'readiness':
                items.sort((a, b) => {
                    const aRank = readinessRank[a.color] ?? 999;
                    const bRank = readinessRank[b.color] ?? 999;
                    if (aRank !== bRank) return aRank - bRank;
                    return a.name.localeCompare(b.name);
                });
                break;
                
            case 'priority':
                items.sort((a, b) => {
                    const aRank = priorityRank[a.color] ?? 999;
                    const bRank = priorityRank[b.color] ?? 999;
                    if (aRank !== bRank) return aRank - bRank;
                    return a.name.localeCompare(b.name);
                });
                break;
                
            case 'location':
                items.sort((a, b) => {
                    const aLoc = a.last_location_type || 'zzz';
                    const bLoc = b.last_location_type || 'zzz';
                    const aIdx = locationOrder.indexOf(aLoc);
                    const bIdx = locationOrder.indexOf(bLoc);
                    const aRank = aIdx === -1 ? 999 : aIdx;
                    const bRank = bIdx === -1 ? 999 : bIdx;
                    if (aRank !== bRank) return aRank - bRank;
                    if (a.last_location_name && b.last_location_name) {
                        return a.last_location_name.localeCompare(b.last_location_name);
                    }
                    return a.name.localeCompare(b.name);
                });
                break;
                
            case 'case_date':
                if (hasItems) {
                    items.sort((a, b) => {
                        const now = new Date();
                        const aCases = allCases.filter(c => c.tray_id === a.id && new Date(c.case_date) > now);
                        const bCases = allCases.filter(c => c.tray_id === b.id && new Date(c.case_date) > now);
                        
                        const aNextCase = aCases.length > 0 ? new Date(Math.min(...aCases.map(c => new Date(c.case_date)))) : null;
                        const bNextCase = bCases.length > 0 ? new Date(Math.min(...bCases.map(c => new Date(c.case_date)))) : null;
                        
                        if (aNextCase && !bNextCase) return -1;
                        if (!aNextCase && bNextCase) return 1;
                        if (!aNextCase && !bNextCase) return a.name.localeCompare(b.name);
                        
                        return aNextCase - bNextCase;
                    });
                } else {
                    items.sort((a, b) => a.name.localeCompare(b.name));
                }
                break;
        }
    };
    
    applySorting(sortedTrays, true);
    applySorting(sortedStandalones, false);
    
    // Render with headers
    let html = '';
    
    if (sortedTrays.length > 0) {
        html += '<div style="font-size: 18px; font-weight: 700; color: #1f2937; margin: 16px 0 12px 0; padding: 0 4px;">Trays</div>';
        html += sortedTrays.map(tray => renderTrayCard(tray)).join('');
    }
    
    if (sortedStandalones.length > 0) {
        html += '<div style="font-size: 18px; font-weight: 700; color: #1f2937; margin: 24px 0 12px 0; padding: 0 4px;">Standalone</div>';
        html += sortedStandalones.map(item => renderStandaloneCard(item)).join('');
    }
    
    listEl.innerHTML = html;
}

function renderTrayCard(tray) {
    let statusLabel = 'No location set';
    let statusClass = `status-${tray.status}`;
    
    if (tray.last_location_type) {
        statusLabel = tray.last_location_type;
        if (tray.last_location_name) {
            statusLabel += ` - ${tray.last_location_name}`;
        }
    }
    
    let locationInfo = '';
    if (tray.last_seen_at) {
        const timestamp = tray.last_seen_at.endsWith('Z') ? tray.last_seen_at : tray.last_seen_at + 'Z';
        const lastSeen = new Date(timestamp);
        const now = new Date();
        const diffMs = now - lastSeen;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        let timeAgo = '';
        if (diffDays > 0) {
            timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else if (diffHours > 0) {
            timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffMins > 0) {
            timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else {
            timeAgo = 'just now';
        }
        
        locationInfo = `<div class="tray-location">üìç Dropped off ${timeAgo}</div>`;
    }
    
    let priorityBadge = '';
    if (tray.priority_numeric) {
        priorityBadge = `<span class="tray-status" style="background:#ffebee;color:#c62828;">P${tray.priority_numeric}</span>`;
    } else if (tray.priority_partial) {
        priorityBadge = `<span class="tray-status" style="background:#e3f2fd;color:#1565c0;">Partial</span>`;
    }
    
    return `
        <div class="tray-card ${tray.color}" onclick="openTray(${tray.id})">
            <div class="tray-name">${tray.name}</div>
            <span class="tray-status ${statusClass}">
                ${statusLabel}
            </span>
            ${priorityBadge}
            ${tray.items && tray.items.length > 0 ? `<div style="margin-top:8px;font-size:14px;color:#86868b;">${tray.items.length} items</div>` : ''}
            ${locationInfo}
        </div>
    `;
}

function renderStandaloneCard(item) {
    let statusLabel = 'No location set';
    let statusClass = `status-${item.status}`;
    
    if (item.last_location_type) {
        statusLabel = item.last_location_type;
        if (item.last_location_name) {
            statusLabel += ` - ${item.last_location_name}`;
        }
    }
    
    let locationInfo = '';
    if (item.last_seen_at) {
        const timestamp = item.last_seen_at.endsWith('Z') ? item.last_seen_at : item.last_seen_at + 'Z';
        const lastSeen = new Date(timestamp);
        const now = new Date();
        const diffMs = now - lastSeen;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        let timeAgo = '';
        if (diffDays > 0) {
            timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else if (diffHours > 0) {
            timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffMins > 0) {
            timeAgo = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        } else {
            timeAgo = 'just now';
        }
        
        locationInfo = `<div class="tray-location">üìç Dropped off ${timeAgo}</div>`;
    }
    
    let priorityBadge = '';
    if (item.priority_numeric) {
        priorityBadge = `<span class="tray-status" style="background:#ffebee;color:#c62828;">P${item.priority_numeric}</span>`;
    } else if (item.priority_partial) {
        priorityBadge = `<span class="tray-status" style="background:#e3f2fd;color:#1565c0;">Partial</span>`;
    }
    
    const stockInfo = item.qty_expected 
        ? `${item.qty_on_hand || 0}/${item.qty_expected}` 
        : 'No qty tracking';
    
    return `
        <div class="tray-card ${item.color}" onclick="openStandaloneItem(${item.id})">
            <div class="tray-name">${item.name}</div>
            <span class="tray-status ${statusClass}">
                ${statusLabel}
            </span>
            ${priorityBadge}
            <div style="margin-top:8px;font-size:14px;color:#86868b;">Stock: ${stockInfo}</div>
            ${locationInfo}
        </div>
    `;
}


        async function openTray(trayId) {
            currentTray = allTrays.find(t => t.id === trayId);
            if (!currentTray) return;
        
            document.getElementById('modalTrayName').textContent = currentTray.name;
            
            // Get pinned notes for this tray
            let pinnedNotes = [];
            try {
                const notesResponse = await fetch(`${API_URL}/trays/${trayId}/notes`);
                pinnedNotes = await notesResponse.json();
            } catch (error) {
                console.error('Failed to load pinned notes:', error);
            }

            
            // Format detailed status with location and timestamp
            let detailedStatus = currentTray.status.replace('_', ' ').toUpperCase();
            if (currentTray.status === 'in_location') {
                if (currentTray.last_location_type) {
                    detailedStatus = currentTray.last_location_type;
                    if (currentTray.last_location_name) {
                        detailedStatus += ` - ${currentTray.last_location_name}`;
                    }
                    
                    // Add timestamp if available
                    if (currentTray.last_seen_at) {
                        const timestamp = currentTray.last_seen_at.endsWith('Z') ? currentTray.last_seen_at : currentTray.last_seen_at + 'Z';
                        const lastSeen = new Date(timestamp);
                        
                        const hours = lastSeen.getHours();
                        const minutes = lastSeen.getMinutes().toString().padStart(2, '0');
                        const ampm = hours >= 12 ? 'pm' : 'am';
                        const displayHours = hours % 12 || 12;
                        const month = (lastSeen.getMonth() + 1).toString();
                        const day = lastSeen.getDate().toString();
                        const year = lastSeen.getFullYear().toString().slice(-2);
                        
                        detailedStatus += ` - ${displayHours}:${minutes} ${ampm} on ${month}/${day}/${year}`;
                    }
                } else {
                    detailedStatus = 'IN LOCATION';
                }
            }
            
            // Smart Preview Item Categorization
            const itemsHtml = generateSmartItemPreview(currentTray.items);
            
            // Build pinned notes HTML
            const notesHtml = pinnedNotes.length > 0
                ? '<div style="margin: 16px 0;"><div style="font-weight: 600; margin-bottom: 12px;">üìå Pinned Notes</div>' +
                  pinnedNotes.map(note => `
                    <div class="pinned-note">
                        <div class="pinned-note-title">${note.title}</div>
                        <div class="pinned-note-content">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</div>
                    </div>
                  `).join('') + '</div>'
                : '';
            
            // Get photos for this tray
            let photos = [];
            try {
                const photosResponse = await fetch(`${API_URL}/photos/tray/${trayId}`);
                photos = await photosResponse.json();
            } catch (error) {
                console.error('Failed to load photos:', error);
            }

            const photosHtml = photos.length > 0
                ? '<div style="margin: 16px 0;"><div style="font-weight: 600; margin-bottom: 12px;">üì∑ Photos</div>' +
                  '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">' +
                  photos.map(photo => `
                    <div style="position: relative;">
                        <img src="${photo.image_data}" onclick="viewPhoto(${photo.id}, 'tray', ${trayId})" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;" />
                        ${photo.caption ? `<div style="font-size: 11px; color: #86868b; margin-top: 4px;">${photo.caption}</div>` : ''}
                    </div>
                  `).join('') + '</div></div>'
                : '';

            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f7; border-radius: 8px;">
                    <div style="font-size: 14px; color: #86868b;">Status</div>
                    <div style="font-size: 16px; font-weight: 500; margin-top: 4px;">
                        ${detailedStatus}
                    </div>
                </div>
                ${itemsHtml}
                ${notesHtml}
                ${photosHtml}

                <button class="btn btn-primary" onclick="showAddPhotoOptions('tray', ${trayId})">üì∑ Add Photo</button>
                <button class="btn btn-primary" onclick="showDropoffForm()">Drop Off at Location</button>
                <button class="btn btn-primary" onclick="showInventoryCheckForm()">Check Inventory</button>
                <button class="btn btn-success" onclick="showRestockForm()">Restock</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            `;
            
            document.getElementById('trayModal').classList.add('show');
        }

        async function openStandaloneItem(itemId) {
    const item = allStandaloneItems.find(i => i.id === itemId);
    if (!item) return;

    currentTray = { ...item, items: [] }; // Treat as tray for shared functions
    
    // Get pinned notes
    let pinnedNotes = [];
    try {
        const notesResponse = await fetch(`${API_URL}/standalone-items/${itemId}/notes`);
        pinnedNotes = await notesResponse.json();
    } catch (error) {
        console.error('Failed to load pinned notes:', error);
    }
    
    // Get photos
    let photos = [];
    try {
        const photosResponse = await fetch(`${API_URL}/photos/standalone/${itemId}`);
        photos = await photosResponse.json();
    } catch (error) {
        console.error('Failed to load photos:', error);
    }

    let detailedStatus = item.status.replace('_', ' ').toUpperCase();
    if (item.status === 'in_location') {
        if (item.last_location_type) {
            detailedStatus = item.last_location_type;
            if (item.last_location_name) {
                detailedStatus += ` - ${item.last_location_name}`;
            }
            
            if (item.last_seen_at) {
                const timestamp = item.last_seen_at.endsWith('Z') ? item.last_seen_at : item.last_seen_at + 'Z';
                const lastSeen = new Date(timestamp);
                
                const hours = lastSeen.getHours();
                const minutes = lastSeen.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'pm' : 'am';
                const displayHours = hours % 12 || 12;
                const month = (lastSeen.getMonth() + 1).toString();
                const day = lastSeen.getDate().toString();
                const year = lastSeen.getFullYear().toString().slice(-2);
                
                detailedStatus += ` - ${displayHours}:${minutes} ${ampm} on ${month}/${day}/${year}`;
            }
        } else {
            detailedStatus = 'IN LOCATION';
        }
    }
    
    const stockInfo = item.qty_expected 
        ? `${item.qty_on_hand || 0}/${item.qty_expected}` 
        : 'No quantity tracking';
    
    const notesHtml = pinnedNotes.length > 0
        ? '<div style="margin: 16px 0;"><div style="font-weight: 600; margin-bottom: 12px;">üìå Pinned Notes</div>' +
          pinnedNotes.map(note => `
            <div class="pinned-note">
                <div class="pinned-note-title">${note.title}</div>
                <div class="pinned-note-content">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</div>
            </div>
          `).join('') + '</div>'
        : '';
    
    const photosHtml = photos.length > 0
        ? '<div style="margin: 16px 0;"><div style="font-weight: 600; margin-bottom: 12px;">üì∑ Photos</div>' +
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">' +
          photos.map(photo => `
            <div style="position: relative;">
                <img src="${photo.image_data}" onclick="viewPhoto(${photo.id}, 'standalone', ${itemId})" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;" />
                ${photo.caption ? `<div style="font-size: 11px; color: #86868b; margin-top: 4px;">${photo.caption}</div>` : ''}
            </div>
          `).join('') + '</div></div>'
        : '';
    
    document.getElementById('modalTrayName').textContent = item.name;
    document.getElementById('modalContent').innerHTML = `
        <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f7; border-radius: 8px;">
            <div style="font-size: 14px; color: #86868b;">Status</div>
            <div style="font-size: 16px; font-weight: 500; margin-top: 4px;">
                ${detailedStatus}
            </div>
        </div>
        <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f7; border-radius: 8px;">
            <div style="font-size: 14px; color: #86868b;">Stock</div>
            <div style="font-size: 16px; font-weight: 500; margin-top: 4px;">
                ${stockInfo}${item.is_critical ? ' <span class="critical-badge">CRITICAL</span>' : ''}
            </div>
        </div>
        ${notesHtml}
        ${photosHtml}

        <button class="btn btn-primary" onclick="showAddPhotoOptions('standalone', ${itemId})">üì∑ Add Photo</button>
        <button class="btn btn-primary" onclick="showDropoffFormStandalone(${itemId})">Drop Off at Location</button>
        <button class="btn btn-primary" onclick="showInventoryCheckFormStandalone(${itemId})">Check Inventory</button>
        <button class="btn btn-success" onclick="showRestockFormStandalone(${itemId})">Restock</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    `;
    
    document.getElementById('trayModal').classList.add('show');
}

function showDropoffFormStandalone(itemId) {
    const item = allStandaloneItems.find(i => i.id === itemId);
    if (!item) return;
    
    document.getElementById('modalContent').innerHTML = `
        <div class="form-group">
            <label class="form-label">Location Type</label>
            <select id="locationType" class="form-select" onchange="updateLocationFieldRequirement()">
                <option value="Hospital">Hospital</option>
                <option value="Warehouse">Warehouse</option>
                <option value="Vehicle">Vehicle</option>
                <option value="Office">Office</option>
                <option value="Storage">Storage</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" id="locationNameLabel">Location Name *</label>
            <div style="position: relative;">
                <input type="text" id="locationName" class="form-input" placeholder="Start typing location name..." oninput="filterLocationSuggestions()" autocomplete="off">
                <div id="locationSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d2d2d7; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Case ID (Optional)</label>
            <input type="text" id="caseId" class="form-input" placeholder="CASE-2024-001">
        </div>
        <div class="form-group">
            <label class="form-label">Notes (Optional)</label>
            <input type="text" id="notes" class="form-input" placeholder="Any additional notes">
        </div>
        <button class="btn btn-primary" onclick="submitDropoffStandalone(${itemId})">Confirm Drop Off</button>
        <button class="btn btn-secondary" onclick="openStandaloneItem(${itemId})">Back</button>
    `;
    
    updateLocationFieldRequirement();
}

async function submitDropoffStandalone(itemId) {
    const coords = await getGPS();
    const locationType = document.getElementById('locationType').value;
    const locationName = document.getElementById('locationName').value.trim();
    
    if (locationType === 'Hospital' && !locationName) {
        showError('Location name is required for Hospital drop-offs');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/standalone-items/${itemId}/dropoff`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: USER_ID,
                gps: coords,
                location_type: locationType,
                location_name: locationName || null,
                case_id: document.getElementById('caseId').value || null,
                notes: document.getElementById('notes').value || null
            })
        });
        
        if (!response.ok) throw new Error('Failed to drop off');
        
        showSuccess('Item dropped off successfully!');
        closeModal();
        loadTrays();
    } catch (error) {
        showError('Failed to drop off item');
        console.error(error);
    }
}

function showInventoryCheckFormStandalone(itemId) {
    const item = allStandaloneItems.find(i => i.id === itemId);
    if (!item) return;
    
    const currentLocation = item.last_location_type || 'Hospital';
    const currentLocationName = item.last_location_name || '';
    const currentStock = item.qty_on_hand !== null ? item.qty_on_hand : 0;
    const expectedStock = item.qty_expected !== null ? item.qty_expected : '?';
    
    document.getElementById('modalContent').innerHTML = `
        <p style="margin-bottom: 16px; font-size: 14px; color: #86868b;">
            Current stock: ${currentStock}/${expectedStock}
        </p>
        <div class="form-group">
            <label class="form-label">Quantity Used</label>
            <input type="number" id="qtyUsed" class="form-input" placeholder="How many used?" min="0" max="${currentStock}" value="0">
        </div>
        <div class="form-group">
            <label class="form-label">Update Location *</label>
            <select id="invCheckLocationType" class="form-select">
                <option value="${currentLocation}">${currentLocation} (current)</option>
                ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                    .filter(loc => loc !== currentLocation)
                    .map(loc => `<option value="${loc}">${loc}</option>`)
                    .join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Location Name (Optional)</label>
            <input type="text" id="invCheckLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
        </div>
        <div class="form-group">
            <label class="form-label">Priority (Required)</label>
            <div class="priority-selector">
                <button class="priority-btn" onclick="selectPriority(1)">P1 (High)</button>
                <button class="priority-btn" onclick="selectPriority(2)">P2 (Med)</button>
                <button class="priority-btn" onclick="selectPriority(3)">P3 (Low)</button>
            </div>
        </div>
        <button class="btn btn-primary" onclick="submitInventoryCheckStandalone(${itemId})">Submit Check</button>
        <button class="btn btn-secondary" onclick="openStandaloneItem(${itemId})">Back</button>
    `;
}

async function submitInventoryCheckStandalone(itemId) {
    const coords = await getGPS();
    const qtyUsed = parseInt(document.getElementById('qtyUsed').value) || 0;
    
    if (selectedPriority === null) {
        showError('Please select a priority level');
        return;
    }
    
    const locationType = document.getElementById('invCheckLocationType').value;
    const locationName = document.getElementById('invCheckLocationName').value.trim();
    
    try {
        const response = await fetch(`${API_URL}/standalone-items/${itemId}/inventory-check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: USER_ID,
                gps: coords,
                qty_used: qtyUsed,
                user_priority_numeric: selectedPriority,
                location_type: locationType,
                location_name: locationName || null
            })
        });
        
        if (!response.ok) throw new Error('Failed to check inventory');
        
        showSuccess('Inventory check completed!');
        closeModal();
        loadTrays();
    } catch (error) {
        showError('Failed to check inventory');
        console.error(error);
    }
}

function showRestockFormStandalone(itemId) {
    const item = allStandaloneItems.find(i => i.id === itemId);
    if (!item) return;
    
    const currentLocation = item.last_location_type || 'Hospital';
    const currentLocationName = item.last_location_name || '';
    
    document.getElementById('modalContent').innerHTML = `
        <p style="margin-bottom: 16px;">Choose restock type:</p>
        <div class="form-group">
            <label class="form-label">Update Location *</label>
            <select id="restockLocationType" class="form-select">
                <option value="${currentLocation}">${currentLocation} (current)</option>
                ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                    .filter(loc => loc !== currentLocation)
                    .map(loc => `<option value="${loc}">${loc}</option>`)
                    .join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Location Name (Optional)</label>
            <input type="text" id="restockLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
        </div>
        <button class="btn btn-success" onclick="submitFullRestockStandalone(${itemId})">Full Restock</button>
        <button class="btn btn-primary" onclick="showPartialRestockFormStandalone(${itemId})">Partial Restock</button>
        <button class="btn btn-secondary" onclick="openStandaloneItem(${itemId})">Back</button>
    `;
}

async function submitFullRestockStandalone(itemId) {
    const coords = await getGPS();
    const locationType = document.getElementById('restockLocationType').value;
    const locationName = document.getElementById('restockLocationName').value.trim();
    
    try {
        const response = await fetch(`${API_URL}/standalone-items/${itemId}/restock-full`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: USER_ID,
                gps: coords,
                location_type: locationType,
                location_name: locationName || null
            })
        });
        
        if (!response.ok) throw new Error('Failed to restock');
        
        showSuccess('Item fully restocked!');
        closeModal();
        loadTrays();
    } catch (error) {
        showError('Failed to restock item');
        console.error(error);
    }
}

function showPartialRestockFormStandalone(itemId) {
    const item = allStandaloneItems.find(i => i.id === itemId);
    if (!item) return;
    
    const currentLocation = item.last_location_type || 'Hospital';
    const currentLocationName = item.last_location_name || '';
    const currentStock = item.qty_on_hand || 0;
    const expectedStock = item.qty_expected || 0;
    const maxRestock = Math.max(0, expectedStock - currentStock);
    
    document.getElementById('modalContent').innerHTML = `
        <p style="margin-bottom: 16px; font-size: 14px; color: #86868b;">
            Current stock: ${currentStock}/${expectedStock}
        </p>
        <div class="form-group">
            <label class="form-label">Quantity Restocked</label>
            <input type="number" id="qtyRestocked" class="form-input" placeholder="How many added?" min="1" max="${maxRestock}" value="1">
            <div id="restockPreview" style="font-size: 12px; color: #007aff; margin-top: 4px;">New stock: ${Math.min(currentStock + 1, expectedStock)}/${expectedStock}</div>
        </div>
        <div class="form-group">
            <label class="form-label">Update Location *</label>
            <select id="partialRestockLocationType" class="form-select">
                <option value="${currentLocation}">${currentLocation} (current)</option>
                ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                    .filter(loc => loc !== currentLocation)
                    .map(loc => `<option value="${loc}">${loc}</option>`)
                    .join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Location Name (Optional)</label>
            <input type="text" id="partialRestockLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
        </div>
        <div class="form-group">
            <label class="form-label">Remaining Priority</label>
            <div class="priority-selector">
                <button class="priority-btn" onclick="selectNewPriority('partial')">Partial (Blue)</button>
                <button class="priority-btn" onclick="selectNewPriority(1)">P1 (High)</button>
                <button class="priority-btn" onclick="selectNewPriority(2)">P2 (Med)</button>
                <button class="priority-btn" onclick="selectNewPriority(3)">P3 (Low)</button>
            </div>
        </div>
        <button class="btn btn-success" onclick="submitPartialRestockStandalone(${itemId}, ${currentStock}, ${expectedStock})">Submit Restock</button>
        <button class="btn btn-secondary" onclick="showRestockFormStandalone(${itemId})">Back</button>
    `;
    
    // Add input listener for preview
    document.getElementById('qtyRestocked').addEventListener('input', function() {
        const qtyAdded = parseInt(this.value) || 0;
        const newStock = Math.min(currentStock + qtyAdded, expectedStock);
        document.getElementById('restockPreview').textContent = `New stock: ${newStock}/${expectedStock}`;
    });
}

async function submitPartialRestockStandalone(itemId, currentStock, expectedStock) {
    const coords = await getGPS();
    const qtyRestocked = parseInt(document.getElementById('qtyRestocked').value) || 0;
    
    if (qtyRestocked <= 0) {
        showError('Please enter a quantity to restock');
        return;
    }
    
    const locationType = document.getElementById('partialRestockLocationType').value;
    const locationName = document.getElementById('partialRestockLocationName').value.trim();
    
    try {
        const response = await fetch(`${API_URL}/standalone-items/${itemId}/restock-partial`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: USER_ID,
                gps: coords,
                qty_restocked: qtyRestocked,
                new_priority: newPriority,
                location_type: locationType,
                location_name: locationName || null
            })
        });
        
        if (!response.ok) throw new Error('Failed to partial restock');
        
        showSuccess('Partial restock completed!');
        closeModal();
        loadTrays();
    } catch (error) {
        showError('Failed to partial restock');
        console.error(error);
    }
}

        function generateSmartItemPreview(items) {
            if (items.length === 0) {
                return '<div style="margin: 16px 0; color: #86868b;">No items in tray</div>';
            }

            // Categorize items with new logic
            const criticalEmpty = [];      // Red - Critical items at 0
            const empty = [];              // Red - Any items at 0
            const lowStock = [];           // Orange - Below 50% stock (but > 0)
            const needsAttention = [];     // Yellow - Between 50-99% stock
            const fullStock = [];          // Green - At 100% stock

            items.forEach(item => {
                if (item.qty_expected === null || item.qty_expected === undefined) {
                    fullStock.push(item);
                    return;
                }

                const current = item.qty_on_hand || 0;
                const expected = item.qty_expected;
                const percentStocked = (current / expected) * 100;

                // Critical: Any critical item at 0 stock
                if (current === 0 && item.is_critical) {
                    criticalEmpty.push(item);
                }
                // Empty: Any non-critical item at 0 stock
                else if (current === 0) {
                    empty.push(item);
                }
                // Low Stock: Below 50% but greater than 0
                else if (percentStocked < 50) {
                    lowStock.push(item);
                }
                // Needs Attention: 50-99%
                else if (percentStocked < 100) {
                    needsAttention.push(item);
                }
                // Full Stock: 100%
                else {
                    fullStock.push(item);
                }
            });

            let html = '<div style="margin: 16px 0;">';

            // üî¥ Critical Empty Items (Red)
            if (criticalEmpty.length > 0) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <div class="item-category-header critical" onclick="toggleItemCategory('critical')" style="cursor: pointer; padding: 12px; background: #ffebee; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <span style="font-size: 18px; margin-right: 8px;">üö®</span>
                                <strong style="color: #1d1d1f;">Critical Items Empty (${criticalEmpty.length})</strong>
                            </div>
                            <span id="critical-arrow" style="font-size: 12px; color: #1d1d1f;">‚ñº</span>
                        </div>
                        <div id="critical-items" style="display: none; padding: 8px 12px; background: #fff; border: 1px solid #ffcdd2; border-top: none; border-radius: 0 0 8px 8px;">
                            ${criticalEmpty.map(item => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #f5f5f7; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 500; color: #c62828;">${item.name}</div>
                                        <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 600; color: #c62828;">0/${item.qty_expected}</div>
                                        <div style="font-size: 11px; color: #c62828;">CRITICAL</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // üî¥ Empty Items (Red - At 0 stock, non-critical)
            if (empty.length > 0) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <div class="item-category-header empty" onclick="toggleItemCategory('empty')" style="cursor: pointer; padding: 12px; background: #ffebee; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <span style="font-size: 18px; margin-right: 8px;">üî¥</span>
                                <strong style="color: #1d1d1f;">Empty (${empty.length})</strong>
                            </div>
                            <span id="empty-arrow" style="font-size: 12px; color: #1d1d1f;">‚ñº</span>
                        </div>
                        <div id="empty-items" style="display: none; padding: 8px 12px; background: #fff; border: 1px solid #ffcdd2; border-top: none; border-radius: 0 0 8px 8px;">
                            ${empty.map(item => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #f5f5f7; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 500; color: #c62828;">${item.name}</div>
                                        <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 600; color: #c62828;">0/${item.qty_expected}</div>
                                        <div style="font-size: 11px; color: #c62828;">EMPTY</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // üü† Low Stock Items (Orange - Below 50% but above 0)
            if (lowStock.length > 0) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <div class="item-category-header low-stock" onclick="toggleItemCategory('low-stock')" style="cursor: pointer; padding: 12px; background: #fff3e0; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <span style="font-size: 18px; margin-right: 8px;">üü†</span>
                                <strong style="color: #1d1d1f;">Low Stock (${lowStock.length})</strong>
                            </div>
                            <span id="low-stock-arrow" style="font-size: 12px; color: #1d1d1f;">‚ñº</span>
                        </div>
                        <div id="low-stock-items" style="display: none; padding: 8px 12px; background: #fff; border: 1px solid #ffe0b2; border-top: none; border-radius: 0 0 8px 8px;">
                            ${lowStock.map(item => {
                                const current = item.qty_on_hand || 0;
                                const expected = item.qty_expected;
                                const percent = Math.round((current / expected) * 100);
                                return `
                                <div style="padding: 8px 0; border-bottom: 1px solid #f5f5f7; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 500;">${item.name}${item.is_critical ? ' <span class="critical-badge">CRITICAL</span>' : ''}</div>
                                        <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 600; color: #ef6c00;">${current}/${expected}</div>
                                        <div style="font-size: 11px; color: #ef6c00;">${percent}% STOCKED</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            }

            // üü° Needs Attention Items (Yellow - 50-99%)
            if (needsAttention.length > 0) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <div class="item-category-header needs-attention" onclick="toggleItemCategory('needs-attention')" style="cursor: pointer; padding: 12px; background: #fffde7; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <span style="font-size: 18px; margin-right: 8px;">üü°</span>
                                <strong style="color: #1d1d1f;">Needs Attention (${needsAttention.length})</strong>
                            </div>
                            <span id="needs-attention-arrow" style="font-size: 12px; color: #1d1d1f;">‚ñº</span>
                        </div>
                        <div id="needs-attention-items" style="display: none; padding: 8px 12px; background: #fff; border: 1px solid #fff9c4; border-top: none; border-radius: 0 0 8px 8px;">
                            ${needsAttention.map(item => {
                                const current = item.qty_on_hand || 0;
                                const expected = item.qty_expected;
                                const percent = Math.round((current / expected) * 100);
                                return `
                                <div style="padding: 8px 0; border-bottom: 1px solid #f5f5f7; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 500;">${item.name}${item.is_critical ? ' <span class="critical-badge">CRITICAL</span>' : ''}</div>
                                        <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; font-weight: 600; color: #f57f17;">${current}/${expected}</div>
                                        <div style="font-size: 11px; color: #f57f17;">${percent}% STOCKED</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            }

            // üü¢ Full Stock Items (Green - 100%)
            if (fullStock.length > 0) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <div class="item-category-header full-stock" onclick="toggleItemCategory('full-stock')" style="cursor: pointer; padding: 12px; background: #e8f5e9; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <span style="font-size: 18px; margin-right: 8px;">‚úÖ</span>
                                <strong style="color: #1d1d1f;">${fullStock.length} items fully stocked</strong>
                            </div>
                            <span id="full-stock-arrow" style="font-size: 12px; color: #1d1d1f;">‚ñ∂</span>
                        </div>
                        <div id="full-stock-items" style="display: none; padding: 8px 12px; background: #fff; border: 1px solid #c8e6c9; border-top: none; border-radius: 0 0 8px 8px;">
                            ${fullStock.map(item => {
                                const current = item.qty_on_hand || 0;
                                const expected = item.qty_expected;
                                const stockInfo = expected ? `${current}/${expected}` : 'No qty tracking';
                                return `
                                <div style="padding: 8px 0; border-bottom: 1px solid #f5f5f7; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 14px;">${item.name}${item.is_critical ? ' <span class="critical-badge">CRITICAL</span>' : ''}</div>
                                        <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 14px; color: #2e7d32;">${stockInfo}</div>
                                        ${expected ? '<div style="font-size: 11px; color: #2e7d32;">FULL</div>' : ''}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function toggleItemCategory(category) {
            const itemsDiv = document.getElementById(`${category}-items`);
            const arrow = document.getElementById(`${category}-arrow`);
            
            if (itemsDiv.style.display === 'none') {
                itemsDiv.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                itemsDiv.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }

        function showDropoffForm() {
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Location Type</label>
                    <select id="locationType" class="form-select" onchange="updateLocationFieldRequirement()">
                        <option value="Hospital">Hospital</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Vehicle">Vehicle</option>
                        <option value="Office">Office</option>
                        <option value="Storage">Storage</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" id="locationNameLabel">Location Name *</label>
                    <div style="position: relative;">
                        <input type="text" id="locationName" class="form-input" placeholder="Start typing location name..." oninput="filterLocationSuggestions()" autocomplete="off">
                        <div id="locationSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d2d2d7; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Case ID (Optional)</label>
                    <input type="text" id="caseId" class="form-input" placeholder="CASE-2024-001">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" id="notes" class="form-input" placeholder="Any additional notes">
                </div>
                <button class="btn btn-primary" onclick="submitDropoff()">Confirm Drop Off</button>
                <button class="btn btn-secondary" onclick="openTray(${currentTray.id})">Back</button>
            `;
            
            // Initialize - Hospital is selected by default, so it's required
            updateLocationFieldRequirement();
        }

        function updateLocationFieldRequirement() {
            const locationType = document.getElementById('locationType').value;
            const label = document.getElementById('locationNameLabel');
            
            if (locationType === 'Hospital') {
                label.textContent = 'Location Name *';
            } else {
                label.textContent = 'Location Name (Optional)';
            }
        }

        function filterLocationSuggestions() {
            const input = document.getElementById('locationName');
            const suggestionsDiv = document.getElementById('locationSuggestions');
            const searchTerm = input.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Get unique locations from all cases
            const uniqueLocations = [...new Set(allCases.map(c => c.location))].filter(loc => 
                loc.toLowerCase().includes(searchTerm)
            );
            
            if (uniqueLocations.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Display suggestions
            suggestionsDiv.innerHTML = uniqueLocations.map(loc => `
                <div onclick="selectLocationSuggestion('${loc.replace(/'/g, "\\'")}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f5f5f7; font-size: 14px;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                    ${loc}
                </div>
            `).join('');
            suggestionsDiv.style.display = 'block';
        }

        function selectLocationSuggestion(location) {
            document.getElementById('locationName').value = location;
            document.getElementById('locationSuggestions').style.display = 'none';
        }

        // Enhanced API call wrapper with offline support
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                
                // Check if this was an offline-queued request
                if (response.status === 202) {
                    const data = await response.json();
                    if (data.offline) {
                        showSuccess(data.message || 'Changes saved offline');
                        return { ok: true, offline: true, data };
                    }
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Request failed');
                }
                
                return { ok: true, data: await response.json() };
            } catch (error) {
                if (!navigator.onLine) {
                    showSuccess('Saved offline - will sync when connected');
                    return { ok: true, offline: true };
                }
                throw error;
            }
        }
        
        async function submitDropoff() {
            const coords = await getGPS();
            const locationType = document.getElementById('locationType').value;
            const locationName = document.getElementById('locationName').value.trim();
            
            // Validate: Hospital requires location name
            if (locationType === 'Hospital' && !locationName) {
                showError('Location name is required for Hospital drop-offs');
                return;
            }
            
            const data = {
                tray_id: currentTray.id,
                user_id: USER_ID,
                gps: coords,
                location_type: locationType,
                location_name: locationName || null,
                case_id: document.getElementById('caseId').value || null,
                notes: document.getElementById('notes').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/scan-events/dropoff`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to drop off');
                
                trackEvent('Tray', 'Dropoff', currentTray.name);
                showSuccess('Tray dropped off successfully!');
                closeModal();
                loadTrays();
            } catch (error) {
                showError('Failed to drop off tray');
                console.error(error);
            }
        }

        function showInventoryCheckForm() {
    const currentLocation = currentTray.last_location_type || 'Hospital';
    const currentLocationName = currentTray.last_location_name || '';
    
    const itemsHtml = currentTray.items.map(item => {
        const currentStock = item.qty_on_hand !== null ? item.qty_on_hand : 0;
        const expectedStock = item.qty_expected !== null ? item.qty_expected : '?';
        const maxQty = currentStock > 0 ? currentStock : 1;
        return `
        <div class="item-checkbox" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="item_${item.id}" value="${item.id}" onchange="toggleQtyInput(${item.id})">
                <label for="item_${item.id}" style="flex: 1;">
                    ${item.name} ${item.is_critical ? '<span class="critical-badge">CRITICAL</span>' : ''}
                    <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku} ‚Ä¢ Stock: ${currentStock}/${expectedStock}</div>
                </label>
            </div>
            <div id="qty_container_${item.id}" style="display: none; margin-top: 8px; padding-left: 32px;">
                <label style="font-size: 12px; color: #86868b; margin-bottom: 4px; display: block;">Quantity Used:</label>
                <input type="number" id="qty_${item.id}" class="form-input" placeholder="How many used?" min="1" max="${maxQty}" value="1" style="width: 120px; padding: 10px; font-size: 16px; text-align: center;">
            </div>
        </div>
    `;
    }).join('');
    
    document.getElementById('modalContent').innerHTML = `
        <p style="margin-bottom: 16px; font-size: 14px; color: #86868b;">
            Select items that need restocking and enter quantity used:
        </p>
        <div class="item-list" style="margin-bottom: 16px;">
            ${itemsHtml}
        </div>
        <div class="form-group">
            <label class="form-label">Update Location *</label>
            <select id="invCheckLocationType" class="form-select">
                <option value="${currentLocation}">${currentLocation} (current)</option>
                ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                    .filter(loc => loc !== currentLocation)
                    .map(loc => `<option value="${loc}">${loc}</option>`)
                    .join('')}
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Location Name (Optional)</label>
            <input type="text" id="invCheckLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
        </div>
        <div class="form-group">
            <label class="form-label">Priority (Required)</label>
            <div class="priority-selector">
                <button class="priority-btn" onclick="selectPriority(1)">P1 (High)</button>
                <button class="priority-btn" onclick="selectPriority(2)">P2 (Med)</button>
                <button class="priority-btn" onclick="selectPriority(3)">P3 (Low)</button>
            </div>
        </div>
        <button class="btn btn-primary" onclick="submitInventoryCheck()">Submit Check</button>
        <button class="btn btn-secondary" onclick="openTray(${currentTray.id})">Back</button>
    `;
}

function toggleQtyInput(itemId) {
    const checkbox = document.getElementById(`item_${itemId}`);
    const qtyContainer = document.getElementById(`qty_container_${itemId}`);
    if (checkbox.checked) {
        qtyContainer.style.display = 'block';
    } else {
        qtyContainer.style.display = 'none';
    }
}

        let selectedPriority = null;
        function selectPriority(priority) {
            selectedPriority = priority;
            document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function submitInventoryCheck() {
    const coords = await getGPS();
    const checkedItems = [];
    
    currentTray.items.forEach(item => {
        const checkbox = document.getElementById(`item_${item.id}`);
        if (checkbox && checkbox.checked) {
            const qtyInput = document.getElementById(`qty_${item.id}`);
            const qtyUsed = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
            
            checkedItems.push({
                item_id: item.id,
                reason: "Needs restock",
                qty_used: qtyUsed
            });
        }
    });
    
    if (checkedItems.length === 0) {
        showError('Please select at least one item');
        return;
    }
    
    if (selectedPriority === null) {
        showError('Please select a priority level');
        return;
    }
    
    const locationType = document.getElementById('invCheckLocationType').value;
    const locationName = document.getElementById('invCheckLocationName').value.trim();
    
    const data = {
        tray_id: currentTray.id,
        user_id: USER_ID,
        gps: coords,
        items: checkedItems,
        user_priority_numeric: selectedPriority,
        location_type: locationType,
        location_name: locationName || null
    };
    
    try {
        const response = await fetch(`${API_URL}/inventory-checks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Failed to check inventory');
                
                trackEvent('Tray', 'InventoryCheck', `${checkedItems.length} items`);
                showSuccess('Inventory check completed!');
                closeModal();
                loadTrays();
            } catch (error) {
        showError('Failed to check inventory');
        console.error(error);
    }
}

        function showRestockForm() {
            const currentLocation = currentTray.last_location_type || 'Hospital';
            const currentLocationName = currentTray.last_location_name || '';
            
            document.getElementById('modalContent').innerHTML = `
                <p style="margin-bottom: 16px;">Choose restock type:</p>
                <div class="form-group">
                    <label class="form-label">Update Location *</label>
                    <select id="restockLocationType" class="form-select">
                        <option value="${currentLocation}">${currentLocation} (current)</option>
                        ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                            .filter(loc => loc !== currentLocation)
                            .map(loc => `<option value="${loc}">${loc}</option>`)
                            .join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location Name (Optional)</label>
                    <input type="text" id="restockLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
                </div>
                <button class="btn btn-success" onclick="submitFullRestock()">Full Restock (All Items)</button>
                <button class="btn btn-primary" onclick="showPartialRestockForm()">Partial Restock</button>
                <button class="btn btn-secondary" onclick="openTray(${currentTray.id})">Back</button>
            `;
        }

        async function submitFullRestock() {
            const coords = await getGPS();
            const locationType = document.getElementById('restockLocationType').value;
            const locationName = document.getElementById('restockLocationName').value.trim();
            
            const data = {
                tray_id: currentTray.id,
                user_id: USER_ID,
                gps: coords,
                location_type: locationType,
                location_name: locationName || null
            };
            
            try {
                const response = await fetch(`${API_URL}/restocks/full`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to restock');
                
                trackEvent('Tray', 'FullRestock', currentTray.name);
                showSuccess('Tray fully restocked!');
                closeModal();
                loadTrays();
            } catch (error) {
                showError('Failed to restock tray');
                console.error(error);
            }
        }

        function showPartialRestockForm() {
            const currentLocation = currentTray.last_location_type || 'Hospital';
            const currentLocationName = currentTray.last_location_name || '';
            
            const itemsHtml = currentTray.items.map(item => {
                const currentStock = item.qty_on_hand !== null ? item.qty_on_hand : 0;
                const expectedStock = item.qty_expected !== null ? item.qty_expected : '?';
                const maxRestock = item.qty_expected ? Math.max(0, item.qty_expected - currentStock) : 999;
                
                return `
                <div class="item-checkbox" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="restock_${item.id}" value="${item.id}" onchange="toggleRestockQtyInput(${item.id})">
                        <label for="restock_${item.id}" style="flex: 1;">
                            ${item.name}
                            <div style="font-size: 12px; color: #86868b;">SKU: ${item.sku} ‚Ä¢ Stock: ${currentStock}/${expectedStock}</div>
                        </label>
                    </div>
                    <div id="restock_qty_container_${item.id}" style="display: none; margin-top: 8px; padding-left: 32px;">
                        <label style="font-size: 12px; color: #86868b; margin-bottom: 4px; display: block;">Quantity Restocked:</label>
                        <input type="number" id="restock_qty_${item.id}" class="form-input" placeholder="How many added?" min="1" max="${maxRestock}" value="1" data-current="${currentStock}" data-expected="${item.qty_expected || 0}" oninput="updateRestockPreview(${item.id})" style="width: 120px; padding: 10px; font-size: 16px; text-align: center;">
                        <div id="restock_preview_${item.id}" style="font-size: 12px; color: #007aff; margin-top: 4px;">New stock: ${Math.min(currentStock + 1, item.qty_expected || currentStock + 1)}/${expectedStock}</div>
                    </div>
                </div>
            `;
            }).join('');
            
            document.getElementById('modalContent').innerHTML = `
                <p style="margin-bottom: 16px; font-size: 14px; color: #86868b;">
                    Select items you restocked and enter quantity added:
                </p>
                <div class="item-list" style="margin-bottom: 16px;">
                    ${itemsHtml}
                </div>
                <div class="form-group">
                    <label class="form-label">Update Location *</label>
                    <select id="partialRestockLocationType" class="form-select">
                        <option value="${currentLocation}">${currentLocation} (current)</option>
                        ${['Hospital', 'Warehouse', 'Vehicle', 'Office', 'Home', 'Storage', 'Other']
                            .filter(loc => loc !== currentLocation)
                            .map(loc => `<option value="${loc}">${loc}</option>`)
                            .join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location Name (Optional)</label>
                    <input type="text" id="partialRestockLocationName" class="form-input" placeholder="e.g., St. Mary's Hospital" value="${currentLocationName}">
                </div>
                <div class="form-group">
                    <label class="form-label">Remaining Priority</label>
                    <div class="priority-selector">
                        <button class="priority-btn" onclick="selectNewPriority('partial')">Partial (Blue)</button>
                        <button class="priority-btn" onclick="selectNewPriority(1)">P1 (High)</button>
                        <button class="priority-btn" onclick="selectNewPriority(2)">P2 (Med)</button>
                        <button class="priority-btn" onclick="selectNewPriority(3)">P3 (Low)</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="submitPartialRestock()">Submit Restock</button>
                <button class="btn btn-secondary" onclick="showRestockForm()">Back</button>
            `;
        }

        function toggleRestockQtyInput(itemId) {
            const checkbox = document.getElementById(`restock_${itemId}`);
            const qtyContainer = document.getElementById(`restock_qty_container_${itemId}`);
            if (checkbox.checked) {
                qtyContainer.style.display = 'block';
            } else {
                qtyContainer.style.display = 'none';
            }
        }

        function updateRestockPreview(itemId) {
            const qtyInput = document.getElementById(`restock_qty_${itemId}`);
            const preview = document.getElementById(`restock_preview_${itemId}`);
            const currentStock = parseInt(qtyInput.dataset.current) || 0;
            const expectedStock = parseInt(qtyInput.dataset.expected) || 0;
            const qtyAdded = parseInt(qtyInput.value) || 0;
            
            const newStock = Math.min(currentStock + qtyAdded, expectedStock);
            const displayExpected = expectedStock > 0 ? expectedStock : '?';
            
            preview.textContent = `New stock: ${newStock}/${displayExpected}`;
        }

        let newPriority = 'partial';
        function selectNewPriority(priority) {
            newPriority = priority;
            document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function submitPartialRestock() {
            const coords = await getGPS();
            const restockedItems = [];
            
            currentTray.items.forEach(item => {
                const checkbox = document.getElementById(`restock_${item.id}`);
                if (checkbox && checkbox.checked) {
                    const qtyInput = document.getElementById(`restock_qty_${item.id}`);
                    const qtyRestocked = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
                    restockedItems.push({ 
                        item_id: item.id,
                        qty_restocked: qtyRestocked
                    });
                }
            });
            
            if (restockedItems.length === 0) {
                showError('Please select at least one item');
                return;
            }
            
            const locationType = document.getElementById('partialRestockLocationType').value;
            const locationName = document.getElementById('partialRestockLocationName').value.trim();
            
            const data = {
                tray_id: currentTray.id,
                user_id: USER_ID,
                gps: coords,
                items: restockedItems,
                new_priority: newPriority,
                location_type: locationType,
                location_name: locationName || null
            };
            
            try {
                const response = await fetch(`${API_URL}/restocks/partial`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Failed to partial restock');
                
                showSuccess('Partial restock completed!');
                closeModal();
                loadTrays();
            } catch (error) {
                showError('Failed to partial restock');
                console.error(error);
            }
        }

        async function createTray() {
            const name = document.getElementById('newTrayName').value.trim();
            if (!name) {
                showError('Please enter a tray name');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/seed/trays`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to create tray');
                }
                
                showSuccess(`Tray "${name}" created!`);
                document.getElementById('newTrayName').value = '';
                loadTraysForAdmin();
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadTraysForAdmin() {
            try {
                const response = await fetch(`${API_URL}/trays`);
                const trays = await response.json();
                
                const select = document.getElementById('itemTraySelect');
                select.innerHTML = '<option value="">Select a tray...</option>' + 
                    trays.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            } catch (error) {
                console.error(error);
            }
        }

        async function addItem() {
            const trayId = document.getElementById('itemTraySelect').value;
            const sku = document.getElementById('itemSku').value.trim();
            const name = document.getElementById('itemName').value.trim();
            const qtyExpected = parseInt(document.getElementById('itemQtyExpected').value) || null;
            const qtyOnHand = parseInt(document.getElementById('itemQtyOnHand').value) || null;
            const isCritical = document.getElementById('itemCritical').checked;
            
            if (!trayId || !sku || !name) {
                showError('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/seed/tray-items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tray_id: parseInt(trayId),
                        sku,
                        name,
                        qty_expected: qtyExpected,
                        qty_on_hand: qtyOnHand,
                        is_critical: isCritical
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to add item');
                }
                
                showSuccess(`Item "${name}" added!`);
                document.getElementById('itemSku').value = '';
                document.getElementById('itemName').value = '';
                document.getElementById('itemQtyExpected').value = '';
                document.getElementById('itemQtyOnHand').value = '';
                document.getElementById('itemCritical').checked = false;
            } catch (error) {
                showError(error.message);
            }
        }

        function showAddItemToTrayForm() {
    document.getElementById('addItemForm').style.display = 'block';
    document.getElementById('addItemForm').innerHTML = `
        <h3 style="margin-bottom: 16px; font-size: 18px; color: #1f2937;">Add Item to Tray</h3>
        <div class="form-group">
            <label class="form-label">Select Tray *</label>
            <select id="itemTraySelect" class="form-select">
                <option value="">Loading trays...</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Type *</label>
            <select id="itemType" class="form-select">
                <option value="">Select type...</option>
                <option value="Screw">Screw</option>
                <option value="Rod">Rod</option>
                <option value="Plate">Plate</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Item Name *</label>
            <input type="text" id="itemName" class="form-input" placeholder="e.g., 5mm Screw">
        </div>
        <div class="form-group">
            <label class="form-label">SKU</label>
            <input type="text" id="itemSku" class="form-input" placeholder="e.g., SCREW-5MM">
        </div>
        <div class="form-group">
            <label class="form-label">Expected Quantity</label>
            <input type="number" id="itemQtyExpected" class="form-input" placeholder="10">
        </div>
        <div class="form-group">
            <label class="form-label">Current Quantity</label>
            <input type="number" id="itemQtyOnHand" class="form-input" placeholder="10">
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="itemCritical">
                <span>Critical Item</span>
            </label>
        </div>
        <button class="btn btn-primary" onclick="addItemToTray()">Add Item</button>
        <button class="btn btn-secondary" onclick="hideAddItemForm()">Cancel</button>
    `;
    
    // Load trays
    loadTraysForAdmin();
}

function showAddStandaloneItemForm() {
    document.getElementById('addItemForm').style.display = 'block';
    document.getElementById('addItemForm').innerHTML = `
        <h3 style="margin-bottom: 16px; font-size: 18px; color: #1f2937;">Add Standalone Item</h3>
        <div class="form-group">
            <label class="form-label">Type *</label>
            <select id="standaloneItemType" class="form-select">
                <option value="">Select type...</option>
                <option value="Cage">Cage</option>
                <option value="Biologic">Biologic</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Item Name *</label>
            <input type="text" id="standaloneItemName" class="form-input" placeholder="e.g., TLIF Cage">
        </div>
        <div class="form-group">
            <label class="form-label">SKU</label>
            <input type="text" id="standaloneItemSku" class="form-input" placeholder="e.g., CAGE-TLIF-10">
        </div>
        <div class="form-group">
            <label class="form-label">Expected Quantity</label>
            <input type="number" id="standaloneItemQtyExpected" class="form-input" placeholder="5">
        </div>
        <div class="form-group">
            <label class="form-label">Current Quantity</label>
            <input type="number" id="standaloneItemQtyOnHand" class="form-input" placeholder="5">
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="standaloneItemCritical">
                <span>Critical Item</span>
            </label>
        </div>
        <button class="btn btn-primary" onclick="addStandaloneItem()">Add Item</button>
        <button class="btn btn-secondary" onclick="hideAddItemForm()">Cancel</button>
    `;
}

function hideAddItemForm() {
    document.getElementById('addItemForm').style.display = 'none';
    document.getElementById('addItemForm').innerHTML = '';
}

async function addItemToTray() {
    const trayId = document.getElementById('itemTraySelect').value;
    const itemType = document.getElementById('itemType').value;
    const name = document.getElementById('itemName').value.trim();
    const sku = document.getElementById('itemSku').value.trim();
    const qtyExpected = parseInt(document.getElementById('itemQtyExpected').value) || null;
    const qtyOnHand = parseInt(document.getElementById('itemQtyOnHand').value) || null;
    const isCritical = document.getElementById('itemCritical').checked;
    
    if (!trayId || !itemType || !name) {
        showError('Please fill in all required fields (Tray, Type, Item Name)');
        return;
    }
    
    // Prepend item type to name if selected
    const fullName = itemType ? `${itemType} - ${name}` : name;
    
    try {
        const response = await fetch(`${API_URL}/seed/tray-items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tray_id: parseInt(trayId),
                sku,
                name: fullName,
                qty_expected: qtyExpected,
                qty_on_hand: qtyOnHand,
                is_critical: isCritical
            })
        });
        
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Failed to add item');
        }
        
        showSuccess(`Item "${fullName}" added to tray!`);
        hideAddItemForm();
    } catch (error) {
        showError(error.message);
    }
}

async function addStandaloneItem() {
    const itemType = document.getElementById('standaloneItemType').value;
    const name = document.getElementById('standaloneItemName').value.trim();
    const sku = document.getElementById('standaloneItemSku').value.trim();
    const qtyExpected = parseInt(document.getElementById('standaloneItemQtyExpected').value) || null;
    const qtyOnHand = parseInt(document.getElementById('standaloneItemQtyOnHand').value) || null;
    const isCritical = document.getElementById('standaloneItemCritical').checked;
    
    if (!itemType || !name) {
        showError('Please fill in all required fields (Type, Item Name)');
        return;
    }
    
    const data = {
        item_type: itemType,
        name: name,
        sku: sku || null,
        qty_expected: qtyExpected,
        qty_on_hand: qtyOnHand,
        is_critical: isCritical
    };
    
    try {
        const response = await fetch(`${API_URL}/standalone-items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Failed to add standalone item');
        }
        
        showSuccess(`Standalone item "${itemType} - ${name}" added successfully!`);
        hideAddItemForm();
        
        // Reload products if on trays tab
        if (document.getElementById('traysTab').style.display !== 'none') {
            loadTrays();
        }
    } catch (error) {
        showError(error.message);
    }
}

        function closeModal() {
            document.getElementById('trayModal').classList.remove('show');
            document.getElementById('caseModal').classList.remove('show');
            document.getElementById('billingNotesModal').classList.remove('show');
            currentTray = null;
        }

        async function getGPS() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        () => {
                            resolve({ lat: 39.7392, lng: -104.9903 });
                        }
                    );
                } else {
                    resolve({ lat: 39.7392, lng: -104.9903 });
                }
            });
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function showLoading(message = 'Loading...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'loading-overlay';
                overlay.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <div class="loading-text" id="loadingText">${message}</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                document.getElementById('loadingText').textContent = message;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function searchTrays() {
            const searchInput = document.getElementById('traySearchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            // Show/hide clear button based on input
            if (searchInput.value.trim()) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            // Trigger sorting/filtering
            sortTrays();
        }

        function clearSearch() {
            document.getElementById('traySearchInput').value = '';
            document.getElementById('clearSearchBtn').style.display = 'none';
            sortTrays();
        }

        // =========================
        // GLOBAL SEARCH FUNCTIONS
        // =========================

        function performGlobalSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            const clearBtn = document.getElementById('clearGlobalSearchBtn');
            const resultsDiv = document.getElementById('globalSearchResults');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Show/hide clear button
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Search across all data types
            const trayResults = allTrays.filter(t => 
                t.name.toLowerCase().includes(searchTerm) ||
                t.items.some(item => item.name.toLowerCase().includes(searchTerm) || item.sku.toLowerCase().includes(searchTerm))
            );
            
            const standaloneResults = allStandaloneItems ? allStandaloneItems.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                (item.sku && item.sku.toLowerCase().includes(searchTerm))
            ) : [];
            
            const caseResults = allCases.filter(c =>
                c.procedure.toLowerCase().includes(searchTerm) ||
                c.location.toLowerCase().includes(searchTerm) ||
                (c.doctor && c.doctor.toLowerCase().includes(searchTerm)) ||
                (c.tray_name && c.tray_name.toLowerCase().includes(searchTerm))
            );
            
            const doctorResults = allDoctors.filter(d =>
                d.name.toLowerCase().includes(searchTerm) ||
                (d.specialty && d.specialty.toLowerCase().includes(searchTerm)) ||
                (d.hospital && d.hospital.toLowerCase().includes(searchTerm))
            );
            
            const noteResults = allNotes.filter(n =>
                n.title.toLowerCase().includes(searchTerm) ||
                n.content.toLowerCase().includes(searchTerm)
            );
            
            const totalResults = trayResults.length + standaloneResults.length + caseResults.length + doctorResults.length + noteResults.length;
            
            if (totalResults === 0) {
                resultsDiv.innerHTML = '<div style="padding: 16px; background: white; border-radius: 12px; text-align: center; color: #86868b;">No results found for "' + searchTerm + '"</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '<div style="background: white; border-radius: 12px; padding: 16px;">';
            html += '<div style="font-weight: 600; margin-bottom: 12px; color: #1f2937;">Search Results (' + totalResults + ')</div>';
            
            // Trays
            if (trayResults.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: #6366f1; margin-bottom: 8px;">üß≥ Trays (' + trayResults.length + ')</div>';
                trayResults.forEach(tray => {
                    const colorEmoji = tray.color === 'red' ? 'üî¥' : tray.color === 'orange' ? 'üü†' : tray.color === 'yellow' ? 'üü°' : tray.color === 'blue' ? 'üîµ' : 'üü¢';
                    html += `
                        <div onclick="openTray(${tray.id}); clearGlobalSearch();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${colorEmoji} ${tray.name}</div>
                            <div style="font-size: 12px; color: #86868b;">${tray.items.length} items</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Standalone Items
            if (standaloneResults.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: #6366f1; margin-bottom: 8px;">üì¶ Standalone Items (' + standaloneResults.length + ')</div>';
                standaloneResults.forEach(item => {
                    const colorEmoji = item.color === 'red' ? 'üî¥' : item.color === 'orange' ? 'üü†' : item.color === 'yellow' ? 'üü°' : item.color === 'blue' ? 'üîµ' : 'üü¢';
                    html += `
                        <div onclick="openStandaloneItem(${item.id}); clearGlobalSearch();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${colorEmoji} ${item.name}</div>
                            <div style="font-size: 12px; color: #86868b;">${item.sku || 'No SKU'}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Cases
            if (caseResults.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: #6366f1; margin-bottom: 8px;">üìÖ Cases (' + caseResults.length + ')</div>';
                caseResults.forEach(c => {
                    const caseDate = new Date(c.case_date);
                    const dateStr = caseDate.toLocaleDateString();
                    html += `
                        <div onclick="showCaseDetailsById(${c.id}); clearGlobalSearch();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${c.procedure}</div>
                            <div style="font-size: 12px; color: #86868b;">${dateStr} ‚Ä¢ ${c.location}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Doctors
            if (doctorResults.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: #6366f1; margin-bottom: 8px;">üë®‚Äç‚öïÔ∏è Doctors (' + doctorResults.length + ')</div>';
                doctorResults.forEach(d => {
                    html += `
                        <div onclick="openDoctor(${d.id}); clearGlobalSearch();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${d.name}</div>
                            <div style="font-size: 12px; color: #86868b;">${d.specialty || 'No specialty'}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Notes
            if (noteResults.length > 0) {
                html += '<div style="margin-bottom: 16px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: #6366f1; margin-bottom: 8px;">üìù Notes (' + noteResults.length + ')</div>';
                noteResults.forEach(n => {
                    html += `
                        <div onclick="openNote(${n.id}); clearGlobalSearch();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <div style="font-weight: 500;">${n.title}</div>
                            <div style="font-size: 12px; color: #86868b;">${n.content.substring(0, 60)}...</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function clearGlobalSearch() {
            document.getElementById('globalSearchInput').value = '';
            document.getElementById('clearGlobalSearchBtn').style.display = 'none';
            document.getElementById('globalSearchResults').style.display = 'none';
        }

        // ===========================
        // CALENDAR FUNCTIONS
        // ===========================

        async function showBookCaseForm() {
            // Load trays for the dropdown
            try {
                const response = await fetch(`${API_URL}/trays`);
                const trays = await response.json();
                
                document.getElementById('modalTrayName').textContent = 'Book a Case';
                document.getElementById('modalContent').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Procedure *</label>
                        <input type="text" id="caseProcedure" class="form-input" placeholder="e.g., Spinal Fusion">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date & Time *</label>
                        <input type="datetime-local" id="caseDateTime" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" id="caseLocation" class="form-input" placeholder="e.g., St. Mary's Hospital">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tray (Optional)</label>
                        <select id="caseTray" class="form-select">
                            <option value="">None</option>
                            ${trays.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherTrayGroup" style="display:none;">
                        <label class="form-label">Other Tray Name</label>
                        <input type="text" id="caseOtherTray" class="form-input" placeholder="Enter tray name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="caseNotes" class="form-input" rows="3" placeholder="Any additional notes"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="createCase()">Book Case</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                `;
                
                // Add event listener for the tray select
                document.getElementById('caseTray').addEventListener('change', function() {
                    const otherGroup = document.getElementById('otherTrayGroup');
                    if (this.value === 'other') {
                        otherGroup.style.display = 'block';
                    } else {
                        otherGroup.style.display = 'none';
                    }
                });
                
                document.getElementById('trayModal').classList.add('show');
            } catch (error) {
                showError('Failed to load booking form');
                console.error(error);
            }
        }

        async function loadTraysForCases() {
            try {
                const response = await fetch(`${API_URL}/trays`);
                const trays = await response.json();
                
                const select = document.getElementById('caseTray');
                if (!select) return; // Exit if element doesn't exist yet
                
                select.innerHTML = '<option value="">None</option>' + 
                    trays.map(t => `<option value="${t.id}">${t.name}</option>`).join('') +
                    '<option value="other">Other</option>';
                
                select.addEventListener('change', function() {
                    const otherGroup = document.getElementById('otherTrayGroup');
                    if (this.value === 'other') {
                        otherGroup.style.display = 'block';
                    } else {
                        otherGroup.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error(error);
            }
        }

        async function createCase() {
            const procedure = document.getElementById('caseProcedure').value.trim();
            const dateTime = document.getElementById('caseDateTime').value;
            const location = document.getElementById('caseLocation').value.trim();
            const traySelect = document.getElementById('caseTray').value;
            const otherTray = document.getElementById('caseOtherTray').value.trim();
            const notes = document.getElementById('caseNotes').value.trim();
            
            if (!procedure || !dateTime || !location) {
                showError('Please fill in all required fields (Procedure, Date/Time, Location)');
                return;
            }
            
            // Keep the datetime as-is without timezone conversion
            const data = {
                procedure,
                case_date: dateTime + ':00',
                location,
                doctor: null,
                tray_id: traySelect && traySelect !== 'other' && traySelect !== '' ? parseInt(traySelect) : null,
                tray_other: traySelect === 'other' ? otherTray : null,
                notes: notes || null
            };
            
            try {
                const response = await fetch(`${API_URL}/cases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to book case');
                }
                
                showSuccess('Case booked successfully!');
                closeModal();
                
                // Refresh calendar
                if (calendar) {
                    loadCalendarEvents();
                }
            } catch (error) {
                showError(error.message);
            }
        }

        function initializeCalendar() {
            if (calendar) {
                loadCalendarEvents();
                return;
            }

            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                timeZone: 'local',
                events: [],
                eventClick: function(info) {
                    showCaseDetails(info.event);
                },
                height: 'auto'
            });
            
            calendar.render();
            loadCalendarEvents();
        }

        async function loadCalendarEvents() {
            try {
                const response = await fetch(`${API_URL}/cases`);
                const cases = await response.json();
                
                const events = cases.map(c => ({
                    id: c.id,
                    title: c.procedure,
                    start: c.case_date,
                    extendedProps: {
                        location: c.location,
                        doctor: c.doctor,
                        tray_name: c.tray_name,
                        tray_other: c.tray_other,
                        notes: c.notes,
                        user_id: c.user_id
                    },
                    backgroundColor: '#007aff',
                    borderColor: '#007aff'
                }));
                
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                }
            } catch (error) {
                showError('Failed to load calendar events');
                console.error(error);
            }
        }

        let currentCase = null;

        async function showCaseDetails(event) {
    currentCase = {
        id: event.id,
        title: event.title,
        start: event.start,
        ...event.extendedProps
    };
    
    const props = event.extendedProps;
    const caseDate = new Date(event.start);
    const dateStr = caseDate.toLocaleDateString();
    const timeStr = caseDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const trayInfo = props.tray_name || props.tray_other || 'No tray assigned';
    
    // Get photos for this case
    let photos = [];
    try {
        const photosResponse = await fetch(`${API_URL}/photos/case/${event.id}`);
        photos = await photosResponse.json();
    } catch (error) {
        console.error('Failed to load photos:', error);
    }

    const photosHtml = photos.length > 0
        ? '<div class="detail-row"><div class="detail-label">Photos</div>' +
          '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">' +
          photos.map(photo => `
            <img src="${photo.image_data}" onclick="viewPhoto(${photo.id}, 'case', ${event.id})" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;" />
          `).join('') + '</div></div>'
        : '';
    
    document.getElementById('caseModalContent').innerHTML = `
        <div class="detail-row">
            <div class="detail-label">Procedure</div>
            <div class="detail-value">${event.title}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Date & Time</div>
            <div class="detail-value">${dateStr} at ${timeStr}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Location</div>
            <div class="detail-value">${props.location}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Tray</div>
            <div class="detail-value">${trayInfo}</div>
        </div>
        ${props.notes ? `
        <div class="detail-row">
            <div class="detail-label">Notes</div>
            <div class="detail-value">${props.notes}</div>
        </div>
        ` : ''}
        ${photosHtml}
        <button class="btn btn-primary" onclick="showAddPhotoOptions('case', ${event.id})">üì∑ Add Photo</button>
        <button class="btn btn-primary" onclick="showEditCaseForm()">Edit Case</button>
        <button class="btn btn-primary" style="background: #ff3b30; margin-top: 8px;" onclick="deleteCaseFromModal(${event.id})">Delete Case</button>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    `;
    
    document.getElementById('caseModal').classList.add('show');
}

        async function deleteCaseFromModal(caseId) {
            if (!confirm('Are you sure you want to delete this case?')) return;
            
            try {
                const response = await fetch(`${API_URL}/cases/${caseId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete case');
                
                showSuccess('Case deleted');
                closeModal();
                loadCalendarEvents();
            } catch (error) {
                showError('Failed to delete case');
                console.error(error);
            }
        }

        async function showEditCaseForm() {
            // Load trays for the dropdown
            try {
                const response = await fetch(`${API_URL}/trays`);
                const trays = await response.json();
                
                // Format the datetime for datetime-local input
                const caseDate = new Date(currentCase.start);
                const year = caseDate.getFullYear();
                const month = String(caseDate.getMonth() + 1).padStart(2, '0');
                const day = String(caseDate.getDate()).padStart(2, '0');
                const hours = String(caseDate.getHours()).padStart(2, '0');
                const minutes = String(caseDate.getMinutes()).padStart(2, '0');
                const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
                
                // Determine which tray option is selected
                let trayOptions = '<option value="">None</option>';
                let selectedTrayId = '';
                let isOtherSelected = false;
                
                trays.forEach(t => {
                    const selected = currentCase.tray_name === t.name ? 'selected' : '';
                    if (selected) selectedTrayId = t.id;
                    trayOptions += `<option value="${t.id}" ${selected}>${t.name}</option>`;
                });
                
                if (currentCase.tray_other) {
                    trayOptions += '<option value="other" selected>Other</option>';
                    isOtherSelected = true;
                } else {
                    trayOptions += '<option value="other">Other</option>';
                }
                
                document.getElementById('caseModalContent').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Procedure *</label>
                        <input type="text" id="editCaseProcedure" class="form-input" value="${currentCase.title}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date & Time *</label>
                        <input type="datetime-local" id="editCaseDateTime" class="form-input" value="${formattedDateTime}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" id="editCaseLocation" class="form-input" value="${currentCase.location}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tray (Optional)</label>
                        <select id="editCaseTray" class="form-select">
                            ${trayOptions}
                        </select>
                    </div>
                    <div class="form-group" id="editOtherTrayGroup" style="display:${isOtherSelected ? 'block' : 'none'};">
                        <label class="form-label">Other Tray Name</label>
                        <input type="text" id="editCaseOtherTray" class="form-input" value="${currentCase.tray_other || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea id="editCaseNotes" class="form-input" rows="3">${currentCase.notes || ''}</textarea>
                    </div>
                    <button class="btn btn-primary" onclick="updateCase()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="showCaseDetailsById(${currentCase.id})">Cancel</button>
                `;
                
                // Add event listener for the tray select
                document.getElementById('editCaseTray').addEventListener('change', function() {
                    const otherGroup = document.getElementById('editOtherTrayGroup');
                    if (this.value === 'other') {
                        otherGroup.style.display = 'block';
                    } else {
                        otherGroup.style.display = 'none';
                    }
                });
                
            } catch (error) {
                showError('Failed to load edit form');
                console.error(error);
            }
        }

        async function updateCase() {
            const procedure = document.getElementById('editCaseProcedure').value.trim();
            const dateTime = document.getElementById('editCaseDateTime').value;
            const location = document.getElementById('editCaseLocation').value.trim();
            const traySelect = document.getElementById('editCaseTray').value;
            const otherTray = document.getElementById('editCaseOtherTray').value.trim();
            const notes = document.getElementById('editCaseNotes').value.trim();
            
            if (!procedure || !dateTime || !location) {
                showError('Please fill in all required fields (Procedure, Date/Time, Location)');
                return;
            }
            
            const data = {
                procedure,
                case_date: dateTime + ':00',
                location,
                doctor: null,
                tray_id: traySelect && traySelect !== 'other' && traySelect !== '' ? parseInt(traySelect) : null,
                tray_other: traySelect === 'other' ? otherTray : null,
                notes: notes || null
            };
            
            try {
                const response = await fetch(`${API_URL}/cases/${currentCase.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to update case');
                }
                
                showSuccess('Case updated successfully!');
                closeModal();
                loadCalendarEvents();
            } catch (error) {
                showError(error.message);
            }
        }

        async function showCaseDetailsById(caseId) {
            // Reload the case details after canceling edit
            const events = calendar.getEvents();
            const event = events.find(e => e.id == caseId);
            if (event) {
                showCaseDetails(event);
            }
        }

        let currentNoteId = null;

        function createNewBillingNote() {
            currentNoteId = null;
            document.getElementById('billingNotesTextarea').value = '';
            document.getElementById('billingNotesModal').classList.add('show');
        }

        function showQuickAddOptions() {
    document.getElementById('modalTrayName').textContent = 'Quick Add';
    document.getElementById('modalContent').innerHTML = `
        <div style="margin-bottom: 16px;">
            <p style="font-size: 14px; color: #86868b; margin-bottom: 16px;">What would you like to add?</p>
            
            <button class="btn btn-primary" onclick="createNewBillingNote()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 20px;">üìù</span>
                <span>Create Note</span>
            </button>
            
            <button class="btn btn-primary" onclick="showQuickAddPhotoOptions()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 20px;">üì∑</span>
                <span>Add Photo</span>
            </button>
            
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    `;
    document.getElementById('trayModal').classList.add('show');
}

function showQuickAddPhotoOptions() {
    document.getElementById('modalTrayName').textContent = 'Add Photo To...';
    
    // Build options for trays and cases
    let traysHtml = '';
    if (allTrays && allTrays.length > 0) {
        traysHtml = `
            <div style="margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #6366f1;">üß≥ Trays</div>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                    ${allTrays.map(tray => `
                        <div onclick="showAddPhotoOptions('tray', ${tray.id}); closeModal();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer; display: flex; align-items: center; justify-content: space-between;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                            <span>${tray.name}</span>
                            <span style="font-size: 12px; color: #86868b;">${tray.items.length} items</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    let casesHtml = '';
    if (allCases && allCases.length > 0) {
        // Get upcoming cases
        const now = new Date();
        const upcomingCases = allCases.filter(c => new Date(c.case_date) >= now).sort((a, b) => new Date(a.case_date) - new Date(b.case_date));
        
        if (upcomingCases.length > 0) {
            casesHtml = `
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #6366f1;">üìÖ Upcoming Cases</div>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                        ${upcomingCases.slice(0, 10).map(c => {
                            const caseDate = new Date(c.case_date);
                            const dateStr = caseDate.toLocaleDateString();
                            return `
                                <div onclick="showAddPhotoOptions('case', ${c.id}); closeModal();" style="padding: 12px; border-bottom: 1px solid #f5f5f7; cursor: pointer;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='white'">
                                    <div style="font-weight: 500;">${c.procedure}</div>
                                    <div style="font-size: 12px; color: #86868b;">${dateStr} ‚Ä¢ ${c.location}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    if (!traysHtml && !casesHtml) {
        document.getElementById('modalContent').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #86868b;">
                No trays or cases available to add photos to.
            </div>
            <button class="btn btn-secondary" onclick="showQuickAddOptions()">Back</button>
        `;
    } else {
        document.getElementById('modalContent').innerHTML = `
            <p style="font-size: 14px; color: #86868b; margin-bottom: 16px;">Select a tray or case to add a photo:</p>
            ${traysHtml}
            ${casesHtml}
            <button class="btn btn-secondary" onclick="showQuickAddOptions()">Back</button>
        `;
    }
}

        function closeBillingNotesModal() {
            document.getElementById('billingNotesModal').classList.remove('show');
            currentNoteId = null;
        }

        function saveBillingNote() {
            const content = document.getElementById('billingNotesTextarea').value.trim();
            
            if (!content) {
                showError('Please enter some content for the note');
                return;
            }
            
            const firstLine = content.split('\n')[0].trim();
            const title = firstLine.substring(0, 50) || 'Untitled Note';
            
            const notes = JSON.parse(localStorage.getItem('billingNotes') || '[]');
            const timestamp = new Date().toISOString();
            
            if (currentNoteId !== null) {
                const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (noteIndex !== -1) {
                    notes[noteIndex] = {
                        id: currentNoteId,
                        title: title,
                        content: content,
                        created: notes[noteIndex].created,
                        updated: timestamp
                    };
                }
            } else {
                const newNote = {
                    id: Date.now(),
                    title: title,
                    content: content,
                    created: timestamp,
                    updated: timestamp
                };
                notes.unshift(newNote);
            }
            
            localStorage.setItem('billingNotes', JSON.stringify(notes));
            showSuccess('Note saved!');
            closeBillingNotesModal();
            
            if (document.getElementById('billingNotesTab').style.display === 'block') {
                loadBillingNotesList();
            }
        }

        function loadBillingNotesList() {
            const notes = JSON.parse(localStorage.getItem('billingNotes') || '[]');
            const listEl = document.getElementById('billingNotesList');
            
            if (notes.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No billing notes yet. Create one from the Dashboard.</div>';
                return;
            }
            
            listEl.innerHTML = notes.map(note => {
                const created = new Date(note.created);
                const dateStr = created.toLocaleDateString();
                const timeStr = created.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                return `
                    <div class="tray-card green" onclick="openBillingNote(${note.id})" style="border-color: #6366f1;">
                        <div class="tray-name">${note.title}</div>
                        <div style="font-size: 14px; color: #86868b; margin-top: 8px;">
                            Created: ${dateStr} ${timeStr}
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openBillingNote(noteId) {
            const notes = JSON.parse(localStorage.getItem('billingNotes') || '[]');
            const note = notes.find(n => n.id === noteId);
            
            if (note) {
                currentNoteId = note.id;
                document.getElementById('billingNotesTextarea').value = note.content;
                document.getElementById('billingNotesModal').classList.add('show');
            }
        }

        function deleteBillingNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;
            
            const notes = JSON.parse(localStorage.getItem('billingNotes') || '[]');
            const filteredNotes = notes.filter(n => n.id !== noteId);
            localStorage.setItem('billingNotes', JSON.stringify(filteredNotes));
            
            showSuccess('Billing note deleted');
            closeBillingNotesModal();
            loadBillingNotesList();
        }

        // =========================
        // DOCTOR FUNCTIONS
        // =========================

        async function loadDoctors() {
            try {
                const response = await fetch(`${API_URL}/doctors`);
                allDoctors = await response.json();
                renderDoctors();
            } catch (error) {
                showError('Failed to load doctors');
                console.error(error);
            }
        }

        function renderDoctors() {
            const listEl = document.getElementById('doctorList');

            if (allDoctors.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No doctors yet. Click "Add Doctor" to create one.</div>';
                return;
            }

            listEl.innerHTML = allDoctors.map(doctor => `
                <div class="doctor-card" onclick="openDoctor(${doctor.id})">
                    <div class="doctor-name">${doctor.name}</div>
                    ${doctor.specialty ? `<div class="doctor-specialty">${doctor.specialty}</div>` : ''}
                    <div class="doctor-contact">
                        ${doctor.hospital ? `üè• ${doctor.hospital}` : ''}
                        ${doctor.phone ? ` ‚Ä¢ üìû ${doctor.phone}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function searchDoctors() {
            const searchInput = document.getElementById('doctorSearchInput');
            const clearBtn = document.getElementById('clearDoctorSearchBtn');
            const listEl = document.getElementById('doctorList');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Show/hide clear button
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                renderDoctors();
                return;
            }
            
            const filteredDoctors = allDoctors.filter(d =>
                d.name.toLowerCase().includes(searchTerm) ||
                (d.specialty && d.specialty.toLowerCase().includes(searchTerm)) ||
                (d.hospital && d.hospital.toLowerCase().includes(searchTerm)) ||
                (d.phone && d.phone.toLowerCase().includes(searchTerm)) ||
                (d.email && d.email.toLowerCase().includes(searchTerm))
            );
            
            if (filteredDoctors.length === 0) {
                listEl.innerHTML = '<div class="empty-state">No doctors found matching "' + searchTerm + '"</div>';
                return;
            }
            
            listEl.innerHTML = filteredDoctors.map(doctor => `
                <div class="doctor-card" onclick="openDoctor(${doctor.id})">
                    <div class="doctor-name">${doctor.name}</div>
                    ${doctor.specialty ? `<div class="doctor-specialty">${doctor.specialty}</div>` : ''}
                    <div class="doctor-contact">
                        ${doctor.hospital ? `üè• ${doctor.hospital}` : ''}
                        ${doctor.phone ? ` ‚Ä¢ üìû ${doctor.phone}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function clearDoctorSearch() {
            document.getElementById('doctorSearchInput').value = '';
            document.getElementById('clearDoctorSearchBtn').style.display = 'none';
            renderDoctors();
        }

        function showCreateDoctorForm() {
            document.getElementById('modalTrayName').textContent = 'Add Doctor';
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="doctorName" class="form-input" placeholder="Dr. John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Specialty</label>
                    <input type="text" id="doctorSpecialty" class="form-input" placeholder="Orthopedic Surgery">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" id="doctorPhone" class="form-input" placeholder="555-1234">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="doctorEmail" class="form-input" placeholder="doctor@hospital.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Hospital</label>
                    <input type="text" id="doctorHospital" class="form-input" placeholder="St. Mary's Hospital">
                </div>
                <button class="btn btn-primary" onclick="createDoctor()">Add Doctor</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        }

        async function createDoctor() {
            const name = document.getElementById('doctorName').value.trim();
            if (!name) {
                showError('Doctor name is required');
                return;
            }

            const data = {
                name,
                specialty: document.getElementById('doctorSpecialty').value.trim() || null,
                phone: document.getElementById('doctorPhone').value.trim() || null,
                email: document.getElementById('doctorEmail').value.trim() || null,
                hospital: document.getElementById('doctorHospital').value.trim() || null,
            };

            try {
                const response = await fetch(`${API_URL}/doctors`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create doctor');

                showSuccess('Doctor added successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to create doctor');
                console.error(error);
            }
        }

        async function openDoctor(doctorId) {
            const doctor = allDoctors.find(d => d.id === doctorId);
            if (!doctor) return;

            // Get pinned notes for this doctor
            let pinnedNotes = [];
            try {
                const notesResponse = await fetch(`${API_URL}/doctors/${doctorId}/notes`);
                pinnedNotes = await notesResponse.json();
            } catch (error) {
                console.error('Failed to load pinned notes:', error);
            }

            const notesHtml = pinnedNotes.length > 0
                ? '<div style="margin-top: 16px;"><div style="font-weight: 600; margin-bottom: 12px;">üìå Pinned Notes</div>' +
                  pinnedNotes.map(note => `
                    <div class="pinned-note">
                        <div class="pinned-note-title">${note.title}</div>
                        <div class="pinned-note-content">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</div>
                    </div>
                  `).join('') + '</div>'
                : '';

            document.getElementById('modalTrayName').textContent = doctor.name;
            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    ${doctor.specialty ? `<div style="color: #6366f1; font-size: 16px; margin-bottom: 8px;">${doctor.specialty}</div>` : ''}
                    ${doctor.hospital ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">üè• ${doctor.hospital}</div>` : ''}
                    ${doctor.phone ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">üìû ${doctor.phone}</div>` : ''}
                    ${doctor.email ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">‚úâÔ∏è ${doctor.email}</div>` : ''}
                </div>
                ${notesHtml}
                <button class="btn btn-primary" onclick="showEditDoctorForm(${doctorId})">Edit</button>
                <button class="btn btn-primary" style="background: #ff3b30;" onclick="deleteDoctor(${doctorId})">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        }

        function showEditDoctorForm(doctorId) {
            const doctor = allDoctors.find(d => d.id === doctorId);
            if (!doctor) return;

            document.getElementById('modalTrayName').textContent = 'Edit Doctor';
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="doctorName" class="form-input" value="${doctor.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Specialty</label>
                    <input type="text" id="doctorSpecialty" class="form-input" value="${doctor.specialty || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" id="doctorPhone" class="form-input" value="${doctor.phone || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="doctorEmail" class="form-input" value="${doctor.email || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Hospital</label>
                    <input type="text" id="doctorHospital" class="form-input" value="${doctor.hospital || ''}">
                </div>
                <button class="btn btn-primary" onclick="updateDoctor(${doctorId})">Save Changes</button>
                <button class="btn btn-secondary" onclick="openDoctor(${doctorId})">Cancel</button>
            `;
        }

        async function updateDoctor(doctorId) {
            const name = document.getElementById('doctorName').value.trim();
            if (!name) {
                showError('Doctor name is required');
                return;
            }

            const data = {
                name,
                specialty: document.getElementById('doctorSpecialty').value.trim() || null,
                phone: document.getElementById('doctorPhone').value.trim() || null,
                email: document.getElementById('doctorEmail').value.trim() || null,
                hospital: document.getElementById('doctorHospital').value.trim() || null,
            };

            try {
                const response = await fetch(`${API_URL}/doctors/${doctorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to update doctor');

                showSuccess('Doctor updated successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to update doctor');
                console.error(error);
            }
        }

        async function deleteDoctor(doctorId) {
            if (!confirm('Are you sure you want to delete this doctor? This will also unpin all notes from this doctor.')) return;

            try {
                const response = await fetch(`${API_URL}/doctors/${doctorId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete doctor');

                showSuccess('Doctor deleted successfully!');
                closeModal();
                loadDoctors();
            } catch (error) {
                showError('Failed to delete doctor');
                console.error(error);
            }
        }

        // =========================
        // NOTE FUNCTIONS
        // =========================

        async function loadNotes() {
            try {
                const response = await fetch(`${API_URL}/notes`);
                allNotes = await response.json();
                renderNotes();
            } catch (error) {
                showError('Failed to load notes');
                console.error(error);
            }
        }

        function renderNotes(notesToRender = null) {
            const listEl = document.getElementById('noteList');
            const notes = notesToRender || allNotes;

            if (notes.length === 0) {
                const searchTerm = document.getElementById('noteSearchInput')?.value.trim();
                const filterValue = document.getElementById('noteFilterSelect')?.value;
                
                if (searchTerm || (filterValue && filterValue !== 'recent')) {
                    listEl.innerHTML = '<div class="empty-state">No notes match your search or filter</div>';
                } else {
                    listEl.innerHTML = '<div class="empty-state">No notes yet. Click "Create Note" to add one.</div>';
                }
                return;
            }

            listEl.innerHTML = notes.map(note => {
                const pinsHtml = note.pins.length > 0
                    ? '<div class="note-pins">' + note.pins.map(pin =>
                        `<span class="pin-badge">${pin.entity_type}: ${pin.entity_name || `ID ${pin.entity_id}`}</span>`
                    ).join('') + '</div>'
                    : '';

                return `
                    <div class="note-card" onclick="openNote(${note.id})">
                        <div class="note-title">${note.title}</div>
                        <div class="note-preview">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
                        ${pinsHtml}
                    </div>
                `;
            }).join('');
        }

        function searchNotes() {
            const searchInput = document.getElementById('noteSearchInput');
            const clearBtn = document.getElementById('clearNoteSearchBtn');
            
            // Show/hide clear button
            if (searchInput.value.trim()) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            filterNotes();
        }

        function clearNoteSearch() {
            document.getElementById('noteSearchInput').value = '';
            document.getElementById('clearNoteSearchBtn').style.display = 'none';
            filterNotes();
        }

        function filterNotes() {
            const searchTerm = document.getElementById('noteSearchInput').value.toLowerCase().trim();
            const filterValue = document.getElementById('noteFilterSelect').value;
            
            let filteredNotes = [...allNotes];
            
            // Apply search filter
            if (searchTerm) {
                filteredNotes = filteredNotes.filter(n =>
                    n.title.toLowerCase().includes(searchTerm) ||
                    n.content.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply category filter
            switch(filterValue) {
                case 'recent':
                    // Already sorted by updated_at desc from API
                    break;
                    
                case 'trays':
                    filteredNotes = filteredNotes.filter(n =>
                        n.pins.some(p => p.entity_type === 'tray')
                    );
                    break;
                    
                case 'standalone':
                    filteredNotes = filteredNotes.filter(n =>
                        n.pins.some(p => p.entity_type === 'standalone')
                    );
                    break;
                    
                case 'cases':
                    filteredNotes = filteredNotes.filter(n =>
                        n.pins.some(p => p.entity_type === 'case')
                    );
                    break;
                    
                case 'doctors':
                    filteredNotes = filteredNotes.filter(n =>
                        n.pins.some(p => p.entity_type === 'doctor')
                    );
                    break;
                    
                case 'unpinned':
                    filteredNotes = filteredNotes.filter(n => n.pins.length === 0);
                    break;
            }
            
            renderNotes(filteredNotes);
        }

        async function showCreateNoteForm() {
            // Load all entities for pinning
            await Promise.all([
                loadTrays(),
                loadDoctors(),
                (async () => {
                    try {
                        const response = await fetch(`${API_URL}/cases`);
                        allCases = await response.json();
                    } catch (error) {
                        console.error('Failed to load cases:', error);
                    }
                })(),
                (async () => {
                    if (!allStandaloneItems) {
                        try {
                            const response = await fetch(`${API_URL}/standalone-items`);
                            allStandaloneItems = await response.json();
                        } catch (error) {
                            console.error('Failed to load standalone items:', error);
                        }
                    }
                })()
            ]);

            const pinToHtml = `
                <div class="pin-to-section">
                    <div class="pin-to-label">üìå Pin To (Optional)</div>

                    ${allTrays.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Trays</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allTrays.map(tray => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_tray_${tray.id}" value="${tray.id}">
                                    <label for="pin_tray_${tray.id}">${tray.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${allStandaloneItems && allStandaloneItems.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Standalone Items</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allStandaloneItems.map(item => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_standalone_${item.id}" value="${item.id}">
                                    <label for="pin_standalone_${item.id}">${item.name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${allCases.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Cases</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allCases.map(c => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_case_${c.id}" value="${c.id}">
                                    <label for="pin_case_${c.id}">${c.procedure} - ${new Date(c.case_date).toLocaleDateString()}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${allDoctors.length > 0 ? `
                    <div>
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Doctors</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allDoctors.map(doctor => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_doctor_${doctor.id}" value="${doctor.id}">
                                    <label for="pin_doctor_${doctor.id}">${doctor.name}${doctor.specialty ? ` (${doctor.specialty})` : ''}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('modalTrayName').textContent = 'Create Note';
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noteTitle" class="form-input" placeholder="Note title">
                </div>
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea id="noteContent" class="form-textarea" placeholder="Write your note here..."></textarea>
                </div>
                ${pinToHtml}
                <button class="btn btn-primary" onclick="createNote()">Create Note</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        }

        async function createNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                showError('Title and content are required');
                return;
            }

            // Collect pins
            const pin_to_trays = allTrays.filter(t =>
                document.getElementById(`pin_tray_${t.id}`)?.checked
            ).map(t => t.id);

            const pin_to_standalone = allStandaloneItems ? allStandaloneItems.filter(item =>
                document.getElementById(`pin_standalone_${item.id}`)?.checked
            ).map(item => item.id) : [];

            const pin_to_cases = allCases.filter(c =>
                document.getElementById(`pin_case_${c.id}`)?.checked
            ).map(c => c.id);

            const pin_to_doctors = allDoctors.filter(d =>
                document.getElementById(`pin_doctor_${d.id}`)?.checked
            ).map(d => d.id);

            const data = {
                title,
                content,
                pin_to_trays: pin_to_trays.length > 0 ? pin_to_trays : null,
                pin_to_standalone: pin_to_standalone.length > 0 ? pin_to_standalone : null,
                pin_to_cases: pin_to_cases.length > 0 ? pin_to_cases : null,
                pin_to_doctors: pin_to_doctors.length > 0 ? pin_to_doctors : null,
            };

            try {
                const response = await fetch(`${API_URL}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create note');

                showSuccess('Note created successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to create note');
                console.error(error);
            }
        }

        async function openNote(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;

            const pinsHtml = note.pins.length > 0
                ? '<div style="margin-top: 16px;"><div style="font-weight: 600; margin-bottom: 8px;">üìå Pinned To:</div>' +
                  '<div style="display: flex; flex-wrap: wrap; gap: 8px;">' +
                  note.pins.map(pin => `
                    <div style="display: inline-flex; align-items: center; background: #ede9fe; color: #6366f1; padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                        <span>${pin.entity_type}: ${pin.entity_name || `ID ${pin.entity_id}`}</span>
                        <button onclick="unpinNote(${noteId}, ${pin.id})" style="margin-left: 8px; background: transparent; border: none; color: #6366f1; cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">√ó</button>
                    </div>
                  `).join('') +
                  '</div></div>'
                : '<div style="margin-top: 16px; color: #86868b;">Not pinned to anything</div>';

            document.getElementById('modalTrayName').textContent = note.title;
            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 16px; white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #374151;">
                    ${note.content}
                </div>
                ${pinsHtml}
                <div style="font-size: 12px; color: #86868b; margin-top: 16px;">
                    Created: ${new Date(note.created_at).toLocaleString()}
                </div>
                <button class="btn btn-primary" onclick="showManagePinsForm(${noteId})">Manage Pins</button>
                <button class="btn btn-primary" onclick="showEditNoteForm(${noteId})">Edit</button>
                <button class="btn btn-primary" style="background: #ff3b30;" onclick="deleteNote(${noteId})">Delete</button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        }

        function showEditNoteForm(noteId) {
            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;

            document.getElementById('modalTrayName').textContent = 'Edit Note';
            document.getElementById('modalContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="noteTitle" class="form-input" value="${note.title}">
                </div>
                <div class="form-group">
                    <label class="form-label">Content *</label>
                    <textarea id="noteContent" class="form-textarea">${note.content}</textarea>
                </div>
                <button class="btn btn-primary" onclick="updateNote(${noteId})">Save Changes</button>
                <button class="btn btn-secondary" onclick="openNote(${noteId})">Cancel</button>
            `;
        }

        async function updateNote(noteId) {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                showError('Title and content are required');
                return;
            }

            const data = { title, content };

            try {
                const response = await fetch(`${API_URL}/notes/${noteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to update note');

                showSuccess('Note updated successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to update note');
                console.error(error);
            }
        }

        async function unpinNote(noteId, pinId) {
            try {
                const response = await fetch(`${API_URL}/notes/${noteId}/pin/${pinId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to unpin note');

                showSuccess('Note unpinned successfully!');
                await loadNotes();
                await openNote(noteId);
            } catch (error) {
                showError('Failed to unpin note');
                console.error(error);
            }
        }

        async function showManagePinsForm(noteId) {
            // Load all entities for pinning
            await Promise.all([
                loadTrays(),
                loadDoctors(),
                (async () => {
                    try {
                        const response = await fetch(`${API_URL}/cases`);
                        allCases = await response.json();
                    } catch (error) {
                        console.error('Failed to load cases:', error);
                    }
                })(),
                (async () => {
                    if (!allStandaloneItems) {
                        try {
                            const response = await fetch(`${API_URL}/standalone-items`);
                            allStandaloneItems = await response.json();
                        } catch (error) {
                            console.error('Failed to load standalone items:', error);
                        }
                    }
                })()
            ]);

            const note = allNotes.find(n => n.id === noteId);
            if (!note) return;

            // Build list of already pinned IDs by type
            const pinnedTrayIds = note.pins.filter(p => p.entity_type === 'tray').map(p => p.entity_id);
            const pinnedStandaloneIds = note.pins.filter(p => p.entity_type === 'standalone').map(p => p.entity_id);
            const pinnedCaseIds = note.pins.filter(p => p.entity_type === 'case').map(p => p.entity_id);
            const pinnedDoctorIds = note.pins.filter(p => p.entity_type === 'doctor').map(p => p.entity_id);

            const pinToHtml = `
                <div class="pin-to-section">
                    <div class="pin-to-label">üìå Add Pins</div>

                    ${allTrays.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Trays</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allTrays.filter(t => !pinnedTrayIds.includes(t.id)).map(tray => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_tray_${tray.id}" value="${tray.id}">
                                    <label for="pin_tray_${tray.id}">${tray.name}</label>
                                </div>
                            `).join('')}
                            ${allTrays.filter(t => !pinnedTrayIds.includes(t.id)).length === 0 ? '<div style="padding: 8px; color: #86868b; font-size: 13px;">All trays already pinned</div>' : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${allStandaloneItems && allStandaloneItems.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Standalone Items</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allStandaloneItems.filter(item => !pinnedStandaloneIds.includes(item.id)).map(item => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_standalone_${item.id}" value="${item.id}">
                                    <label for="pin_standalone_${item.id}">${item.name}</label>
                                </div>
                            `).join('')}
                            ${allStandaloneItems.filter(item => !pinnedStandaloneIds.includes(item.id)).length === 0 ? '<div style="padding: 8px; color: #86868b; font-size: 13px;">All standalone items already pinned</div>' : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${allCases.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Cases</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allCases.filter(c => !pinnedCaseIds.includes(c.id)).map(c => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_case_${c.id}" value="${c.id}">
                                    <label for="pin_case_${c.id}">${c.procedure} - ${new Date(c.case_date).toLocaleDateString()}</label>
                                </div>
                            `).join('')}
                            ${allCases.filter(c => !pinnedCaseIds.includes(c.id)).length === 0 ? '<div style="padding: 8px; color: #86868b; font-size: 13px;">All cases already pinned</div>' : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${allDoctors.length > 0 ? `
                    <div>
                        <div style="font-weight: 500; font-size: 13px; color: #6b7280; margin-bottom: 6px;">Doctors</div>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${allDoctors.filter(d => !pinnedDoctorIds.includes(d.id)).map(doctor => `
                                <div class="pin-checkbox">
                                    <input type="checkbox" id="pin_doctor_${doctor.id}" value="${doctor.id}">
                                    <label for="pin_doctor_${doctor.id}">${doctor.name}${doctor.specialty ? ` (${doctor.specialty})` : ''}</label>
                                </div>
                            `).join('')}
                            ${allDoctors.filter(d => !pinnedDoctorIds.includes(d.id)).length === 0 ? '<div style="padding: 8px; color: #86868b; font-size: 13px;">All doctors already pinned</div>' : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('modalTrayName').textContent = 'Manage Pins';
            document.getElementById('modalContent').innerHTML = `
                <p style="margin-bottom: 16px; font-size: 14px; color: #86868b;">Add new pins to this note:</p>
                ${pinToHtml}
                <button class="btn btn-primary" onclick="addPinsToNote(${noteId})">Add Selected Pins</button>
                <button class="btn btn-secondary" onclick="openNote(${noteId})">Back</button>
            `;
        }

        async function addPinsToNote(noteId) {
            // Collect selected pins
            const selectedTrays = allTrays.filter(t =>
                document.getElementById(`pin_tray_${t.id}`)?.checked
            );
            const selectedStandalones = allStandaloneItems ? allStandaloneItems.filter(item =>
                document.getElementById(`pin_standalone_${item.id}`)?.checked
            ) : [];
            const selectedCases = allCases.filter(c =>
                document.getElementById(`pin_case_${c.id}`)?.checked
            );
            const selectedDoctors = allDoctors.filter(d =>
                document.getElementById(`pin_doctor_${d.id}`)?.checked
            );

            if (selectedTrays.length === 0 && selectedStandalones.length === 0 && selectedCases.length === 0 && selectedDoctors.length === 0) {
                showError('Please select at least one item to pin');
                return;
            }

            try {
                // Add each pin individually
                const pinPromises = [];

                for (const tray of selectedTrays) {
                    pinPromises.push(
                        fetch(`${API_URL}/notes/${noteId}/pin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ entity_type: 'tray', entity_id: tray.id })
                        })
                    );
                }

                for (const item of selectedStandalones) {
                    pinPromises.push(
                        fetch(`${API_URL}/notes/${noteId}/pin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ entity_type: 'standalone', entity_id: item.id })
                        })
                    );
                }

                for (const c of selectedCases) {
                    pinPromises.push(
                        fetch(`${API_URL}/notes/${noteId}/pin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ entity_type: 'case', entity_id: c.id })
                        })
                    );
                }

                for (const doctor of selectedDoctors) {
                    pinPromises.push(
                        fetch(`${API_URL}/notes/${noteId}/pin`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ entity_type: 'doctor', entity_id: doctor.id })
                        })
                    );
                }

                await Promise.all(pinPromises);

                showSuccess('Pins added successfully!');
                await loadNotes();
                await openNote(noteId);
            } catch (error) {
                showError('Failed to add pins');
                console.error(error);
            }
        }
        
        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`${API_URL}/notes/${noteId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete note');

                showSuccess('Note deleted successfully!');
                closeModal();
                loadNotes();
            } catch (error) {
                showError('Failed to delete note');
                console.error(error);
            }
        }

        // =========================
        // METRICS FUNCTIONS
        // =========================

        let allMetrics = [];

        async function loadMetrics() {
            const timePeriod = document.getElementById('metricsTimePeriod').value;
            const contentEl = document.getElementById('metricsContent');
            
            contentEl.innerHTML = '<div class="loading">Loading metrics...</div>';
            
            try {
                const url = timePeriod === 'all' 
                    ? `${API_URL}/metrics/item-utilization`
                    : `${API_URL}/metrics/item-utilization?days=${timePeriod}`;
                    
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load metrics');
                
                allMetrics = await response.json();
                
                renderMetricsSummary(allMetrics);
                filterMetrics();
            } catch (error) {
                contentEl.innerHTML = '<div class="error">Failed to load metrics</div>';
                console.error(error);
            }
        }

        function renderMetricsSummary(metrics) {
            const summaryEl = document.getElementById('metricsSummary');
            
            // Calculate summary stats
            const totalItems = metrics.length;
            const totalUses = metrics.reduce((sum, m) => sum + m.times_used, 0);
            const totalQtyUsed = metrics.reduce((sum, m) => sum + m.total_qty_used, 0);
            const criticalItems = metrics.filter(m => m.is_critical).length;
            
            summaryEl.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #6366f1;">
                    <div style="font-size: 32px; font-weight: 700; color: #6366f1; margin-bottom: 4px;">${totalItems}</div>
                    <div style="font-size: 14px; color: #6b7280;">Tracked Items</div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #10b981;">
                    <div style="font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 4px;">${totalUses}</div>
                    <div style="font-size: 14px; color: #6b7280;">Total Uses</div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f59e0b;">
                    <div style="font-size: 32px; font-weight: 700; color: #f59e0b; margin-bottom: 4px;">${totalQtyUsed}</div>
                    <div style="font-size: 14px; color: #6b7280;">Total Quantity Used</div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ef4444;">
                    <div style="font-size: 32px; font-weight: 700; color: #ef4444; margin-bottom: 4px;">${criticalItems}</div>
                    <div style="font-size: 14px; color: #6b7280;">Critical Items</div>
                </div>
            `;
        }

        function filterMetrics() {
            const filter = document.getElementById('metricsFilter').value;
            const contentEl = document.getElementById('metricsContent');
            
            let filteredMetrics = [...allMetrics];
            
            switch(filter) {
                case 'tray':
                    filteredMetrics = filteredMetrics.filter(m => m.source_type === 'tray');
                    break;
                case 'standalone':
                    filteredMetrics = filteredMetrics.filter(m => m.source_type === 'standalone');
                    break;
                case 'critical':
                    filteredMetrics = filteredMetrics.filter(m => m.is_critical);
                    break;
            }
            
            if (filteredMetrics.length === 0) {
                contentEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #86868b;">No metrics data available for this filter</div>';
                return;
            }
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            html += `
                <thead>
                    <tr style="border-bottom: 2px solid #e5e7eb;">
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">RANK</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">ITEM NAME</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">SKU</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">SOURCE</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">TIMES USED</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">TOTAL QTY</th>
                        <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #6b7280;">AVG QTY/USE</th>
                        <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #6b7280;">LAST USED</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            filteredMetrics.forEach((metric, index) => {
                const lastUsed = metric.last_used 
                    ? new Date(metric.last_used).toLocaleDateString() 
                    : 'Never';
                
                const sourceIcon = metric.source_type === 'tray' ? 'üß≥' : 'üì¶';
                const criticalBadge = metric.is_critical 
                    ? '<span class="critical-badge" style="margin-left: 6px;">CRITICAL</span>' 
                    : '';
                
                html += `
                    <tr style="border-bottom: 1px solid #f5f5f7;">
                        <td style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="font-weight: 700; color: #000000;">#${index + 1}</span>
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <div style="font-weight: 500;">${metric.item_name}${criticalBadge}</div>
                        </td>
                        <td style="padding: 12px; color: #6b7280;">${metric.sku || 'N/A'}</td>
                        <td style="padding: 12px;">
                            <div style="font-size: 13px;">${sourceIcon} ${metric.source_name}</div>
                            <div style="font-size: 11px; color: #9ca3af;">${metric.source_type}</div>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #6366f1;">${metric.times_used}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${metric.total_qty_used}</td>
                        <td style="padding: 12px; text-align: right; color: #6b7280;">${metric.avg_qty_per_use.toFixed(1)}</td>
                        <td style="padding: 12px; color: #6b7280; font-size: 13px;">${lastUsed}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            contentEl.innerHTML = html;
        }
        
        // =========================
        // PWA & OFFLINE SUPPORT
        // =========================

        let isOnline = navigator.onLine;
        let offlineQueue = [];

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                        
                        // Request persistent storage
                        if (navigator.storage && navigator.storage.persist) {
                            navigator.storage.persist().then(granted => {
                                console.log('Persistent storage granted:', granted);
                            });
                        }
                        
                        // Register for background sync if supported
                        if ('sync' in registration) {
                            // Will sync when connection is restored
                        }
                    })
                    .catch(err => console.error('ServiceWorker registration failed:', err));
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SYNC_SUCCESS') {
                        showSuccess('Offline changes synced successfully');
                        // Reload data to show synced changes
                        const currentTab = document.querySelector('.tab.active')?.textContent.toLowerCase();
                        if (currentTab === 'dashboard') loadDashboard();
                        else if (currentTab === 'trays & products') loadTrays();
                    }
                });
            });
        }

        // Show offline indicator
        function updateOnlineStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (isOnline && !wasOnline) {
                showSuccess('Back online - syncing changes...');
                syncOfflineChanges();
            } else if (!isOnline && wasOnline) {
                showOfflineNotification();
            }
            
            updateOfflineIndicator();
        }

        function showOfflineNotification() {
            const notification = document.createElement('div');
            notification.id = 'offlineIndicator';
            notification.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
                color: white;
                padding: 12px 20px;
                text-align: center;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            notification.innerHTML = 'üì° Offline Mode - Changes will sync when connected';
            document.body.prepend(notification);
        }

        function updateOfflineIndicator() {
            const indicator = document.getElementById('offlineIndicator');
            if (!isOnline && !indicator) {
                showOfflineNotification();
            } else if (isOnline && indicator) {
                indicator.remove();
            }
        }

        async function syncOfflineChanges() {
            if (!navigator.onLine) {
                showError('Still offline - will sync when connected');
                return;
            }
            
            showLoading('Syncing offline changes...');
            
            try {
                // Get pending sync items from IndexedDB
                const pendingItems = await getPendingSync();
                
                if (pendingItems.length === 0) {
                    hideLoading();
                    showSuccess('All changes are synced!');
                    return;
                }
                
                let successCount = 0;
                let failCount = 0;
                
                for (const item of pendingItems) {
                    try {
                        // Attempt to replay the action
                        const response = await fetch(item.data.url || `${API_URL}${item.data.endpoint}`, {
                            method: item.data.method || 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...item.data.headers
                            },
                            body: item.data.body ? JSON.stringify(item.data.body) : null
                        });
                        
                        if (response.ok) {
                            await clearSyncedItem(item.id);
                            successCount++;
                        } else {
                            failCount++;
                            // Increment retry count
                            if (item.retries < 3) {
                                item.retries++;
                            } else {
                                // After 3 retries, remove from queue
                                await clearSyncedItem(item.id);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to sync item:', error);
                        failCount++;
                    }
                }
                
                hideLoading();
                
                if (successCount > 0) {
                    showSuccess(`${successCount} change${successCount > 1 ? 's' : ''} synced successfully!`);
                    // Reload current tab data
                    const currentTab = document.querySelector('.tab.active');
                    if (currentTab) {
                        const tabName = currentTab.textContent.toLowerCase();
                        if (tabName.includes('dashboard')) loadDashboard();
                        else if (tabName.includes('trays')) loadTrays();
                        else if (tabName.includes('cases')) initializeCalendar();
                    }
                }
                
                if (failCount > 0) {
                    showError(`${failCount} change${failCount > 1 ? 's' : ''} failed to sync - will retry later`);
                }
                
                // Also trigger service worker sync
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SYNC_NOW' });
                }
            } catch (error) {
                hideLoading();
                showError('Sync failed - will retry automatically');
                console.error('Sync error:', error);
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Check initial status
        updateOnlineStatus();

        // =========================
        // INDEXEDDB FOR OFFLINE DATA
        // =========================

        let db;
        const DB_NAME = 'TrayTrackDB';
        const DB_VERSION = 1;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores for offline data
                    if (!db.objectStoreNames.contains('trays')) {
                        db.createObjectStore('trays', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('cases')) {
                        db.createObjectStore('cases', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('doctors')) {
                        db.createObjectStore('doctors', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('notes')) {
                        db.createObjectStore('notes', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('standaloneItems')) {
                        db.createObjectStore('standaloneItems', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('pendingSync')) {
                        const syncStore = db.createObjectStore('pendingSync', { keyPath: 'id', autoIncrement: true });
                        syncStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // Save data to IndexedDB
        async function saveToIndexedDB(storeName, data) {
            if (!db) await initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                if (Array.isArray(data)) {
                    data.forEach(item => store.put(item));
                } else {
                    store.put(data);
                }
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // Get data from IndexedDB
        async function getFromIndexedDB(storeName, key = null) {
            if (!db) await initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                const request = key ? store.get(key) : store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Queue action for sync when online
        async function queueForSync(action) {
            if (!db) await initDB();
            
            const syncItem = {
                action: action.type,
                data: action.data,
                timestamp: Date.now(),
                retries: 0
            };
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pendingSync'], 'readwrite');
                const store = transaction.objectStore('pendingSync');
                const request = store.add(syncItem);
                
                request.onsuccess = () => {
                    pendingSyncCount++;
                    updateSyncBadge();
                    resolve(request.result);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Get pending sync items
        async function getPendingSync() {
            if (!db) await initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pendingSync'], 'readonly');
                const store = transaction.objectStore('pendingSync');
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Clear synced item
        async function clearSyncedItem(id) {
            if (!db) await initDB();
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pendingSync'], 'readwrite');
                const store = transaction.objectStore('pendingSync');
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    pendingSyncCount = Math.max(0, pendingSyncCount - 1);
                    updateSyncBadge();
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // Update sync badge
        function updateSyncBadge() {
            let badge = document.getElementById('syncBadge');
            if (pendingSyncCount > 0) {
                if (!badge) {
                    badge = document.createElement('div');
                    badge.id = 'syncBadge';
                    badge.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: #ef4444;
                        color: white;
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        z-index: 10001;
                        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                        cursor: pointer;
                    `;
                    badge.onclick = syncOfflineChanges;
                    document.body.appendChild(badge);
                }
                badge.textContent = `${pendingSyncCount} pending`;
            } else if (badge) {
                badge.remove();
            }
        }

        // Initialize DB on load
        initDB().then(() => {
            // Load pending sync count
            getPendingSync().then(items => {
                pendingSyncCount = items.length;
                updateSyncBadge();
            });
        });

        // Prompt to install PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after a delay
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallPrompt();
                }
            }, 5000);
        });

        function showInstallPrompt() {
            const installPrompt = document.createElement('div');
            installPrompt.style.cssText = `
                position: fixed;
                bottom: 90px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
                z-index: 10000;
                max-width: 90%;
                text-align: center;
                animation: slideUp 0.3s ease;
            `;
            installPrompt.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">Install TrayTrack</div>
                <div style="font-size: 13px; margin-bottom: 12px;">Add to home screen for quick access</div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button onclick="installPWA()" style="background: white; color: #6366f1; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">Install</button>
                    <button onclick="dismissInstallPrompt()" style="background: transparent; color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">Later</button>
                </div>
            `;
            installPrompt.id = 'installPrompt';
            document.body.appendChild(installPrompt);
        }

        window.installPWA = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('Install outcome:', outcome);
                deferredPrompt = null;
                dismissInstallPrompt();
            }
        };

        window.dismissInstallPrompt = function() {
            const prompt = document.getElementById('installPrompt');
            if (prompt) prompt.remove();
        };
        
        // =========================
        // LOGIN/LOGOUT SYSTEM
        // =========================

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const displayName = document.getElementById('loginDisplayName').value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            if (!displayName) {
                alert('Please enter your display name');
                return;
            }
            
            // Validate username (alphanumeric only)
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                alert('Username can only contain letters, numbers, and underscores');
                return;
            }
            
            showLoading('Logging in...');
            
            try {
                const response = await fetch(`${API_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, display_name: displayName })
                });
                
                if (!response.ok) throw new Error('Login failed');
                
                CURRENT_USER = await response.json();
                USER_ID = CURRENT_USER.username;
                
                // Save to localStorage
                localStorage.setItem('traytrack_user', JSON.stringify(CURRENT_USER));
                
                // Hide login, show app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userName').textContent = CURRENT_USER.display_name;
                
                hideLoading();
                loadDashboard();
                
                // Show welcome for first-time users
                if (!localStorage.getItem('traytrack_welcome_seen_' + USER_ID)) {
                    setTimeout(() => showWelcomeScreen(), 1000);
                }
            } catch (error) {
                hideLoading();
                alert('Login failed. Please try again.');
                console.error(error);
            }
        }

        function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            localStorage.removeItem('traytrack_user');
            USER_ID = null;
            CURRENT_USER = null;
            
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginDisplayName').value = '';
        }

        // Check for existing login on page load
        function checkExistingLogin() {
            const savedUser = localStorage.getItem('traytrack_user');
            if (savedUser) {
                try {
                    CURRENT_USER = JSON.parse(savedUser);
                    USER_ID = CURRENT_USER.username;
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userName').textContent = CURRENT_USER.display_name;
                    
                    loadDashboard();
                } catch (error) {
                    console.error('Failed to restore session:', error);
                    localStorage.removeItem('traytrack_user');
                }
            }
        }

        function checkFirstTimeUser() {
            if (!USER_ID) return;
            const hasSeenWelcome = localStorage.getItem('traytrack_welcome_seen_' + USER_ID);
            if (!hasSeenWelcome) {
                showWelcomeScreen();
            }
        }

        function showWelcomeScreen() {
            const welcome = document.createElement('div');
            welcome.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10002;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            `;
            
            welcome.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 32px; max-width: 500px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üß≥</div>
                    <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 12px;">Welcome to TrayTrack AI</h2>
                    <p style="font-size: 15px; color: #6b7280; margin-bottom: 24px; line-height: 1.6;">
                        Your medical device inventory management system. Track trays, standalone items, cases, and more - even offline.
                    </p>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 24px; text-align: left;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: #1f2937;">Quick Tips:</div>
                        <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                            ‚úì Works offline - changes sync when connected<br>
                            ‚úì Drop off trays at locations<br>
                            ‚úì Check inventory and flag items<br>
                            ‚úì Track case schedules<br>
                            ‚úì View utilization metrics
                        </div>
                    </div>
                    <button onclick="closeWelcome()" class="btn btn-primary" style="margin-top: 0;">Get Started</button>
                </div>
            `;
            
            welcome.id = 'welcomeScreen';
            document.body.appendChild(welcome);
        }

        window.closeWelcome = function() {
            localStorage.setItem('traytrack_welcome_seen_' + USER_ID, 'true');
            const welcome = document.getElementById('welcomeScreen');
            if (welcome) welcome.remove();
        };

        // =========================
        // FEEDBACK FORM
        // =========================

        window.showFeedbackForm = function() {
            document.getElementById('modalTrayName').textContent = 'Send Feedback';
            document.getElementById('modalContent').innerHTML = `
                <p style="margin-bottom: 16px; font-size: 14px; color: #6b7280;">
                    Help us improve TrayTrack! Share your thoughts, report issues, or suggest features.
                </p>
                <div class="form-group">
                    <label class="form-label">Feedback Type</label>
                    <select id="feedbackType" class="form-select">
                        <option value="bug">üêõ Bug Report</option>
                        <option value="feature">üí° Feature Request</option>
                        <option value="general">üí¨ General Feedback</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Feedback *</label>
                    <textarea id="feedbackText" class="form-textarea" placeholder="Tell us what's on your mind..." rows="6"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (Optional)</label>
                    <input type="email" id="feedbackEmail" class="form-input" placeholder="your@email.com">
                </div>
                <button class="btn btn-primary" onclick="submitFeedback()">Send Feedback</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        };

        window.submitFeedback = function() {
            const type = document.getElementById('feedbackType').value;
            const text = document.getElementById('feedbackText').value.trim();
            const email = document.getElementById('feedbackEmail').value.trim();
            
            if (!text) {
                showError('Please enter your feedback');
                return;
            }
            
            // For pilot, save to localStorage (you can add API endpoint later)
            const feedback = {
                type,
                text,
                email,
                timestamp: new Date().toISOString(),
                version: '2.2-pilot',
                userAgent: navigator.userAgent
            };
            
            const allFeedback = JSON.parse(localStorage.getItem('traytrack_feedback') || '[]');
            allFeedback.push(feedback);
            localStorage.setItem('traytrack_feedback', JSON.stringify(allFeedback));
            
            showSuccess('Thank you for your feedback!');
            closeModal();
            
            console.log('Feedback submitted:', feedback);
        };

// =========================
        // DATA EXPORT FUNCTIONS
        // =========================

        async function exportAllData() {
            showLoading('Preparing export...');
            
            try {
                // Gather all data
                const exportData = {
                    version: '2.2-pilot',
                    exportDate: new Date().toISOString(),
                    userId: USER_ID,
                    data: {
                        trays: allTrays,
                        standaloneItems: allStandaloneItems || [],
                        cases: allCases,
                        doctors: allDoctors,
                        notes: allNotes
                    },
                    feedback: JSON.parse(localStorage.getItem('traytrack_feedback') || '[]'),
                    stats: {
                        totalTrays: allTrays.length,
                        totalStandaloneItems: (allStandaloneItems || []).length,
                        totalCases: allCases.length,
                        totalDoctors: allDoctors.length,
                        totalNotes: allNotes.length
                    }
                };
                
                // Create downloadable file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `traytrack-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                hideLoading();
                showSuccess('Data exported successfully!');
            } catch (error) {
                hideLoading();
                showError('Failed to export data');
                console.error(error);
            }
        }

        async function exportMetrics() {
            showLoading('Preparing metrics export...');
            
            try {
                const response = await fetch(`${API_URL}/metrics/item-utilization`);
                if (!response.ok) throw new Error('Failed to fetch metrics');
                
                const metrics = await response.json();
                
                // Convert to CSV format
                const csvHeaders = ['Rank', 'Item Name', 'SKU', 'Source Type', 'Source Name', 'Critical', 'Times Used', 'Total Qty Used', 'Avg Qty/Use', 'Last Used'];
                const csvRows = metrics.map((m, idx) => [
                    idx + 1,
                    `"${m.item_name}"`,
                    m.sku || 'N/A',
                    m.source_type,
                    `"${m.source_name}"`,
                    m.is_critical ? 'Yes' : 'No',
                    m.times_used,
                    m.total_qty_used,
                    m.avg_qty_per_use.toFixed(2),
                    m.last_used ? new Date(m.last_used).toLocaleDateString() : 'Never'
                ]);
                
                const csvContent = [csvHeaders.join(','), ...csvRows.map(row => row.join(','))].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `traytrack-metrics-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                hideLoading();
                showSuccess('Metrics exported successfully!');
            } catch (error) {
                hideLoading();
                showError('Failed to export metrics');
                console.error(error);
            }
        }

        // =========================
        // USAGE ANALYTICS FOR PILOT
        // =========================

        function trackEvent(category, action, label = null) {
            const event = {
                category,
                action,
                label,
                timestamp: new Date().toISOString(),
                userId: USER_ID,
                version: '2.2-pilot',
                online: navigator.onLine
            };
            
            // Store analytics locally for pilot
            const analytics = JSON.parse(localStorage.getItem('traytrack_analytics') || '[]');
            analytics.push(event);
            
            // Keep only last 1000 events
            if (analytics.length > 1000) {
                analytics.shift();
            }
            
            localStorage.setItem('traytrack_analytics', JSON.stringify(analytics));
            
            // Log for debugging
            console.log('Event tracked:', event);
        }

        // Track page views
        function trackPageView(page) {
            trackEvent('Navigation', 'PageView', page);
        }

        // Enhance showTab to track navigation
        const originalShowTab = showTab;
        showTab = function(tab) {
            originalShowTab.call(this, tab);
            trackPageView(tab);
        };

        // =========================
        // CLEAR DATA FOR TESTING
        // =========================

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL local data including offline changes. This cannot be undone. Are you sure?')) {
                return;
            }
            
            if (!confirm('This is your last chance. Really delete everything?')) {
                return;
            }
            
            showLoading('Clearing all data...');
            
            try {
                // Clear localStorage
                localStorage.removeItem('traytrack_welcome_seen');
                localStorage.removeItem('traytrack_feedback');
                localStorage.removeItem('traytrack_analytics');
                localStorage.removeItem('billingNotes');
                
                // Clear IndexedDB
                if (db) {
                    const stores = ['trays', 'cases', 'doctors', 'notes', 'standaloneItems', 'pendingSync'];
                    stores.forEach(storeName => {
                        const transaction = db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        store.clear();
                    });
                }
                
                // Clear service worker cache
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                
                setTimeout(() => {
                    hideLoading();
                    showSuccess('All data cleared! Reloading...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }, 1000);
            } catch (error) {
                hideLoading();
                showError('Failed to clear data');
                console.error(error);
            }
        }
        
        function showDataStats() {
            const stats = {
                trays: allTrays.length,
                standaloneItems: (allStandaloneItems || []).length,
                trayItems: allTrays.reduce((sum, t) => sum + t.items.length, 0),
                cases: allCases.length,
                doctors: allDoctors.length,
                notes: allNotes.length,
                feedback: JSON.parse(localStorage.getItem('traytrack_feedback') || '[]').length
            };
            
            const upcomingCases = allCases.filter(c => new Date(c.case_date) > new Date()).length;
            const needsRestock = allTrays.filter(t => t.status === 'needs_restock').length;
            
            document.getElementById('modalTrayName').textContent = 'Data Statistics';
            document.getElementById('modalContent').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #6366f1;">${stats.trays}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Trays</div>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #10b981;">${stats.standaloneItems}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Standalone Items</div>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${stats.trayItems}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Total Items in Trays</div>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #06b6d4;">${stats.cases}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Cases</div>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #8b5cf6;">${stats.doctors}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Doctors</div>
                    </div>
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 700; color: #ec4899;">${stats.notes}</div>
                        <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">Notes</div>
                    </div>
                </div>
                
                <div style="background: #fffbeb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;">Quick Insights</div>
                    <div style="font-size: 14px; color: #78350f; line-height: 1.8;">
                        ‚Ä¢ ${upcomingCases} upcoming case${upcomingCases !== 1 ? 's' : ''}<br>
                        ‚Ä¢ ${needsRestock} tray${needsRestock !== 1 ? 's' : ''} need${needsRestock === 1 ? 's' : ''} restocking<br>
                        ‚Ä¢ ${stats.feedback} feedback submission${stats.feedback !== 1 ? 's' : ''} collected
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            `;
            document.getElementById('trayModal').classList.add('show');
        }

        // Initialize on page load
        checkExistingLogin();
    
// =========================
// PHOTO FUNCTIONS
// =========================

function showAddPhotoOptions(entityType, entityId) {
    const targetModal = entityType === 'tray' ? 'modalContent' : 'caseModalContent';
    
    document.getElementById(targetModal).innerHTML = `
        <div style="margin-bottom: 16px;">
            <p style="font-size: 14px; color: #86868b; margin-bottom: 16px;">Choose how to add a photo:</p>
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoSelected('${entityType}', ${entityId})">
            <input type="file" id="galleryInput" accept="image/*" style="display: none;" onchange="handlePhotoSelected('${entityType}', ${entityId})">
            
            <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()">üì∏ Take Photo</button>
            <button class="btn btn-primary" onclick="document.getElementById('galleryInput').click()">üñºÔ∏è Choose from Gallery</button>
            <button class="btn btn-secondary" onclick="${entityType === 'tray' ? `openTray(${entityId})` : `showCaseDetailsById(${entityId})`}">Cancel</button>
        </div>
    `;
}

async function handlePhotoSelected(entityType, entityId) {
    const photoInput = document.getElementById('photoInput');
    const galleryInput = document.getElementById('galleryInput');
    const file = photoInput.files[0] || galleryInput.files[0];
    
    if (!file) return;
    
    // Show preview and caption input
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Data = e.target.result;
        
        document.getElementById('modalContent').innerHTML = `
            <div style="margin-bottom: 16px;">
                <img src="${base64Data}" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px; margin-bottom: 12px;">
                <div class="form-group">
                    <label class="form-label">Caption (Optional)</label>
                    <input type="text" id="photoCaption" class="form-input" placeholder="Add a caption...">
                </div>
                <button class="btn btn-primary" onclick="uploadPhoto('${entityType}', ${entityId}, '${base64Data}', '${file.name}')">Upload Photo</button>
                <button class="btn btn-secondary" onclick="showAddPhotoOptions('${entityType}', ${entityId})">Back</button>
            </div>
        `;
    };
    reader.readAsDataURL(file);
}

async function uploadPhoto(entityType, entityId, base64Data, filename) {
    const caption = document.getElementById('photoCaption').value.trim();
    
    const data = {
        entity_type: entityType,
        entity_id: entityId,
        filename: filename,
        image_data: base64Data,
        caption: caption || null
    };
    
    try {
        const response = await fetch(`${API_URL}/photos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error('Failed to upload photo');
        
        showSuccess('Photo uploaded successfully!');
        
        // Return to entity view
        if (entityType === 'tray') {
            await openTray(entityId);
        } else if (entityType === 'case') {
            await showCaseDetailsById(entityId);
        }
    } catch (error) {
        showError('Failed to upload photo');
        console.error(error);
    }
}

function viewPhoto(photoId, entityType, entityId) {
    fetch(`${API_URL}/photos/${entityType}/${entityId}`)
        .then(response => response.json())
        .then(photos => {
            const photo = photos.find(p => p.id === photoId);
            if (!photo) return;
            
            const createdDate = new Date(photo.created_at).toLocaleString();
            
            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <img src="${photo.image_data}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px; margin-bottom: 12px;">
                    ${photo.caption ? `<div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">${photo.caption}</div>` : ''}
                    <div style="font-size: 12px; color: #86868b; margin-bottom: 16px;">Added ${createdDate}</div>
                    <button class="btn btn-primary" style="background: #ff3b30;" onclick="deletePhoto(${photoId}, '${entityType}', ${entityId})">Delete Photo</button>
                    <button class="btn btn-secondary" onclick="${entityType === 'tray' ? `openTray(${entityId})` : `showCaseDetailsById(${entityId})`}">Back</button>
                </div>
            `;
        });
}

async function deletePhoto(photoId, entityType, entityId) {
    if (!confirm('Are you sure you want to delete this photo?')) return;
    
    try {
        const response = await fetch(`${API_URL}/photos/${photoId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Failed to delete photo');
        
        showSuccess('Photo deleted successfully!');
        
        // Return to entity view
        if (entityType === 'tray') {
            await openTray(entityId);
        } else if (entityType === 'case') {
            await showCaseDetailsById(entityId);
        }
    } catch (error) {
        showError('Failed to delete photo');
        console.error(error);
    }
}
    </script>
</body>
</html>

